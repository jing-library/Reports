---
title: "Stats"
output: 
  html_document: 
    toc: true
    toc_float: true
    collapsed: false
    number_sections: false
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE,warning=FALSE, cache=TRUE)

#install.packages("pivottabler")
library(tidyverse)
library(pivottabler)
```


# OA Stats
This section is to track the OA status and citation counts of publications by the Tech authors with the publication dates from 2016 through 2020. 

```{r March-data-as-baseline}

#---- Prepare March data for analysis ----
scopus_202203_1 <- read_csv("data/scopus_2016_20220301.csv")
scopus_202203_2 <- read_csv("data/scopus_2017_20220301.csv")
scopus_202203_3 <- read_csv("data/scopus_2018_20220301.csv")
scopus_202203_4 <- read_csv("data/scopus_2019_20220301.csv")
scopus_202203_5 <- read_csv("data/scopus_2020_20220301.csv")

# combine all the 5 files into 1
scopus_march <- rbind(scopus_202203_1, scopus_202203_2, scopus_202203_3, scopus_202203_4, scopus_202203_5)
rm(scopus_202203_1, scopus_202203_2,scopus_202203_3,scopus_202203_4,scopus_202203_5)

# select only columns relevant
scopus_march <- scopus_march[c(1,3,4,5,12,13,15:17,19)]

#rename columns
names(scopus_march)[c(1:10)] <- c("author", "title", "year", "source_title", "citations_march", "DOI", "doc_type", "pub_stage", "oa_status_march", "EID")

# Replace NAs in citations and OA status, remove rows with missing or duplicated DOIs
scopus_march <- scopus_march %>% 
  replace_na(list(oa_status_march = "Closed", citations_march = 0)) %>% 
  filter(!is.na(DOI)) %>% 
  filter(!DOI %in% DOI[duplicated(DOI)])

```

## November
Scopus application is used to retrieve data on November 1st, 2022. 


```{r, November-data-preparation}

# read November data
scopus_november <- read_csv("data/scopus_20221101.csv")


# select only columns relevant
scopus_november <- scopus_november[c(1,3,4,5,12,13,15:17,19)]

# rename columns
names(scopus_november)[c(1:10)] <- c("author", "title", "year", "source_title", "citations_november", "DOI", "doc_type", "pub_stage", "oa_status_november", "EID")


# Replace NAs in citations and OA status, remove rows with missing or duplicated DOIs
scopus_november <- scopus_november %>% 
  replace_na(list(oa_status_november = "Closed", citations_november = 0)) %>% 
  filter(!is.na(DOI)) %>% 
  filter(!DOI %in% DOI[duplicated(DOI)]) %>% 
  write_csv("data_intermediate/scopus_november.csv")

# read October data
scopus_october <- read_csv("data_intermediate/scopus_october.csv")


# records removed from March
removed_11 <- anti_join(scopus_march, scopus_november, by = "DOI") 
removed_11 <- removed_11 %>%
  select(source_title, year, pub_stage, oa_status_march, DOI) %>% 
  arrange(source_title) %>% 
  write_csv("data_intermediate/removed_11.csv")

# new records in November
added_11 <- anti_join(scopus_november, scopus_march, by = "DOI") 

added_11 <- added_11 %>% 
  select(source_title, year, pub_stage, oa_status_november, DOI) %>%
  arrange(source_title)

# shared items of September and October
main_11 <- inner_join(scopus_october, scopus_november, by = "DOI")
main_11 <- main_11[-c(11:14, 16, 17, 19)]

names(main_11)[c(1:12)] <- c("author", "title", "year", "source_title", "citations_october", "DOI", "doc_type", "pub_stage", "oa_status_october", "EID", "citations_november", "oa_status_november")
```
* Number of records (Comparing with March)
  After removing records with missing DOIs or duplicated DOIs, **9,872 records** were kept. **55 items** were removed from the data set of March and **118 items** were added. The total data change was **around 1.8%**.
  
* OA Status (Comparing with October)
  * Comparing with October, the OA status of **120 items** changed. 24 OA items turned to be closed; while 35 items became open access. 
  * **19 items turned green where 10 of them were closed items in October**. 7 items lost their green status.

```{r, November-findings}

#---- Findings - OA Status ----

oa_status_change_11 <- main_11 %>% 
  select(title, source_title, year, oa_status_october, oa_status_november, DOI) %>%
  filter(main_11$oa_status_october != main_11$oa_status_november) %>% 
  arrange(source_title) 

open2close_11 <- oa_status_change_11 %>% 
  filter(oa_status_november == "Closed") %>% 
  write_csv("data_intermediate/open2close_11.csv")

close2open_11 <- oa_status_change_11 %>% 
  filter(oa_status_october == "Closed")

# close2green_10 <- oa_status_change_10 %>% 
#   filter(oa_status_september == "Closed" & oa_status_october == "All Open Access, Green") %>% 
#   write_csv("data_intermediate/close2green_10.csv")


close2green_11 <- oa_status_change_11 %>% 
  filter(oa_status_october == "Closed" & str_detect(oa_status_november, "Green")) %>% 
  write_csv("data_intermediate/close2green_11.csv")

  
green_added_11 <- oa_status_change_11 %>% 
  filter(!str_detect(oa_status_october, "Green") & str_detect(oa_status_november, "Green"))

green_removed_11 <- oa_status_change_11 %>% 
  filter(str_detect(oa_status_october, "Green") & !str_detect(oa_status_november, "Green"))
```

Publications by Year & by OA Status (Data Retrieved on November 1)
```{r, November-OA-status}

# OA status in November
main_11 %>% 
  separate(oa_status_november, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(year) %>% 
  count(is_oa, oa_status) %>% 
  mutate(percent = 100*n/sum(n)) %>% 
  ungroup() %>% 
  qhpvt(
    c("is_oa","oa_status"), 
    "year", 
    c("Count" = "sum(n)", "%" = "sum(percent)"),
    formats = list("%.0f", "%.2f"),
    totals = list("is_oa" = "Total", "oa_status" = "Total"),
    totalStyle = list("font-weight"="bold")
    )
```
* Citations
  * Comparing with October, **2,514 items** obtained more citations.
  * Citations per paper(CpP) for OA publications was **33.50** while for closed publications was **around 12.02**. 

```{r, November-citations}


# Citations in November
citations_change_11 <- main_11 %>% 
  select(title, source_title, year, citations_october, citations_november) %>% 
  filter(citations_november-citations_october != 0) %>% 
  mutate(citations_diff = citations_november - citations_october, 
         citations_percentage = ifelse(
           citations_october != 0, (citations_november - citations_october)*100 / citations_october, ifelse(citations_october == 0, NA, 999))) %>% 
  arrange(desc(citations_diff), desc(citations_percentage))

citations_error_11 <- citations_change_11 %>% 
  select(title, source_title, year, citations_october, citations_november, citations_diff) %>%
  filter(citations_diff < 0)

citations_per_paper_11 <- main_11 %>%
  separate(oa_status_november, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(is_oa) %>% 
  mutate(CpP_10 = sum(citations_november)/n())
```
Citations by Year & by OA Status (Data Retrieved on November 1)

```{r, November-citations-per-paper}


# Citations per Paper in November
main_11 %>% 
  separate(oa_status_november, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(year, oa_status) %>% 
  mutate(citations_per_paper = round(sum(citations_november)/n())) %>%   # added a new column the citations per paper
  select(year, is_oa, oa_status, citations_november, citations_per_paper) %>%  
  ungroup() %>%  
  qhpvt(
    c("is_oa", "oa_status"), 
    "year", 
    c("Count" = "n()", "CpP" = "sum(citations_per_paper)/n()"),
    formats = list("%.0f", "%.0f"),
    totals = list("oa_status" = "Total", "Year" = "Total"),
    totalStyle = list("font-weight"="bold")
    )
```



## October
Scopus application is used to retrieve data on October 1st, 2022. 


```{r, October-data-preparation}

# read October data
scopus_october <- read_csv("data/scopus_20221001.csv")


# select only columns relevant
scopus_october <- scopus_october[c(1,3,4,5,12,13,15:17,19)]

# rename columns
names(scopus_october)[c(1:10)] <- c("author", "title", "year", "source_title", "citations_october", "DOI", "doc_type", "pub_stage", "oa_status_october", "EID")


# Replace NAs in citations and OA status, remove rows with missing or duplicated DOIs
scopus_october <- scopus_october %>% 
  replace_na(list(oa_status_october = "Closed", citations_october = 0)) %>% 
  filter(!is.na(DOI)) %>% 
  filter(!DOI %in% DOI[duplicated(DOI)]) %>% 
  write_csv("data_intermediate/scopus_october.csv")

# read September data
scopus_september <- read_csv("data_intermediate/scopus_september.csv")


# records removed from March
removed_10 <- anti_join(scopus_march, scopus_october, by = "DOI") 
removed_10 <- removed_10 %>%
  select(source_title, year, pub_stage, oa_status_march, DOI) %>% 
  arrange(source_title) %>% 
  write_csv("data_intermediate/removed_10.csv")

# new records in October
added_10 <- anti_join(scopus_october, scopus_march, by = "DOI") 

added_10 <- added_10 %>% 
  select(source_title, year, pub_stage, oa_status_october, DOI) %>%
  arrange(source_title)

# shared items of September and October
main_10 <- inner_join(scopus_september, scopus_october, by = "DOI")
main_10 <- main_10[-c(11:14, 16, 17, 19)]

names(main_10)[c(1:12)] <- c("author", "title", "year", "source_title", "citations_september", "DOI", "doc_type", "pub_stage", "oa_status_september", "EID", "citations_october", "oa_status_october")
```
* Number of records (Comparing with March)
  After removing records with missing DOIs or duplicated DOIs, **9,880 records** were kept. **47 items** were removed from the data set of March and **108 items** were added. The total data change was **around 1.6%**.
  
* OA Status (Comparing with September)
  * Comparing with September, the OA status of **59 items** changed. 11 OA items turned to be closed; while 10 items became open access. 
  * **17 items turned green where 4 of them were closed items in September**. 2 items lost their green status.

```{r, October-findings}

#---- Findings - OA Status ----

oa_status_change_10 <- main_10 %>% 
  select(title, source_title, year, oa_status_september, oa_status_october, DOI) %>%
  filter(main_10$oa_status_september != main_10$oa_status_october) %>% 
  arrange(source_title) 

open2close_10 <- oa_status_change_10 %>% 
  filter(oa_status_october == "Closed") %>% 
  write_csv("data_intermediate/open2close_10.csv")

close2open_10 <- oa_status_change_10 %>% 
  filter(oa_status_september == "Closed")

# close2green_10 <- oa_status_change_10 %>% 
#   filter(oa_status_september == "Closed" & oa_status_october == "All Open Access, Green") %>% 
#   write_csv("data_intermediate/close2green_10.csv")


close2green_10 <- oa_status_change_10 %>% 
  filter(oa_status_september == "Closed" & str_detect(oa_status_october, "Green")) %>% 
  write_csv("data_intermediate/close2green_10.csv")

  
green_added_10 <- oa_status_change_10 %>% 
  filter(!str_detect(oa_status_september, "Green") & str_detect(oa_status_october, "Green"))

green_removed_10 <- oa_status_change_10 %>% 
  filter(str_detect(oa_status_september, "Green") & !str_detect(oa_status_october, "Green"))
```

Publications by Year & by OA Status (Data Retrieved on October 1)
```{r, October-OA-status}

# OA status in October
main_10 %>% 
  separate(oa_status_october, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(year) %>% 
  count(is_oa, oa_status) %>% 
  mutate(percent = 100*n/sum(n)) %>% 
  ungroup() %>% 
  qhpvt(
    c("is_oa","oa_status"), 
    "year", 
    c("Count" = "sum(n)", "%" = "sum(percent)"),
    formats = list("%.0f", "%.2f"),
    totals = list("is_oa" = "Total", "oa_status" = "Total"),
    totalStyle = list("font-weight"="bold")
    )
```
* Citations
  * Comparing with September, **2,404 items** obtained more citations.
  * Citations per paper(CpP) for OA publications was **32.87** while for closed publications was **around 11.70**. 

```{r, October-citations}


# Citations in October
citations_change_10 <- main_10 %>% 
  select(title, source_title, year, citations_september, citations_october) %>% 
  filter(citations_october-citations_september != 0) %>% 
  mutate(citations_diff = citations_october - citations_september, 
         citations_percentage = ifelse(
           citations_september != 0, (citations_october - citations_september)*100 / citations_september, ifelse(citations_september == 0, NA, 999))) %>% 
  arrange(desc(citations_diff), desc(citations_percentage))

citations_error_10 <- citations_change_10 %>% 
  select(title, source_title, year, citations_september, citations_october, citations_diff) %>%
  filter(citations_diff < 0)

citations_per_paper_10 <- main_10 %>%
  separate(oa_status_october, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(is_oa) %>% 
  mutate(CpP_10 = sum(citations_october)/n())
```
Citations by Year & by OA Status (Data Retrieved on October 1)

```{r, October-citations-per-paper}


# Citations per Paper in October
main_10 %>% 
  separate(oa_status_october, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(year, oa_status) %>% 
  mutate(citations_per_paper = round(sum(citations_october)/n())) %>%   # added a new column the citations per paper
  select(year, is_oa, oa_status, citations_october, citations_per_paper) %>%  
  ungroup() %>%  
  qhpvt(
    c("is_oa", "oa_status"), 
    "year", 
    c("Count" = "n()", "CpP" = "sum(citations_per_paper)/n()"),
    formats = list("%.0f", "%.0f"),
    totals = list("oa_status" = "Total", "Year" = "Total"),
    totalStyle = list("font-weight"="bold")
    )
```

## September
Scopus application is used to retrieve data on September 1st, 2022. 


```{r, September-data-preparation}

# read September data
scopus_september <- read_csv("data/scopus_20220901.csv")


# select only columns relevant
scopus_september <- scopus_september[c(1,3,4,5,12,13,15:17,19)]

# rename columns
names(scopus_september)[c(1:10)] <- c("author", "title", "year", "source_title", "citations_september", "DOI", "doc_type", "pub_stage", "oa_status_september", "EID")


# Replace NAs in citations and OA status, remove rows with missing or duplicated DOIs
scopus_september <- scopus_september %>% 
  replace_na(list(oa_status_september = "Closed", citations_september = 0)) %>% 
  filter(!is.na(DOI)) %>% 
  filter(!DOI %in% DOI[duplicated(DOI)]) %>% 
  write_csv("data_intermediate/scopus_september.csv")

# read August data
scopus_august <- read_csv("data_intermediate/scopus_august.csv")


# records removed from March
removed_09 <- anti_join(scopus_march, scopus_september, by = "DOI") 
removed_09 <- removed_09 %>%
  select(source_title, year, pub_stage, oa_status_march, DOI) %>% 
  arrange(source_title) %>% 
  write_csv("data_intermediate/removed_09.csv")

# new records in September
added_09 <- anti_join(scopus_september, scopus_march, by = "DOI") 

added_09 <- added_09 %>% 
  select(source_title, year, pub_stage, oa_status_september, DOI) %>%
  arrange(source_title)

# shared items of August and September
main_09 <- inner_join(scopus_august, scopus_september, by = "DOI")
main_09 <- main_09[-c(11:14, 16, 17, 19)]

names(main_09)[c(1:12)] <- c("author", "title", "year", "source_title", "citations_august", "DOI", "doc_type", "pub_stage", "oa_status_august", "EID", "citations_september", "oa_status_september")
```
* Number of records (Comparing with March)
  After removing records with missing DOIs or duplicated DOIs, **9,863 records** were kept. **41 items** were removed from the data set of March and **85 items** were added. The total data change was **around 1.3%**.
  
* OA Status (Comparing with August)
  * Comparing with August, the OA status of **78 items** changed. 17 OA items turned to be closed; while 24 items became open access. 
  * **15 items turned green where 6 of them were closed items in August**. 12 items lost their green status.

```{r, September-findings}

#---- Findings - OA Status ----
oa_status_change_09 <- main_09 %>% 
  select(title, source_title, year, oa_status_august, oa_status_september, DOI) %>% 
  filter(main_09$oa_status_august != main_09$oa_status_september) %>% 
  arrange(source_title) 

open2close_09 <- oa_status_change_09 %>% 
  filter(oa_status_september == "Closed") %>% 
  write_csv("data_intermediate/open2close_09.csv")

close2open_09 <- oa_status_change_09 %>% 
  filter(oa_status_august == "Closed")

# close2green_09 <- oa_status_change_09 %>% 
#   filter(oa_status_august == "Closed" & oa_status_september == "All Open Access, Green") %>% 
#   write_csv("data_intermediate/close2green_09.csv")


close2green_09 <- oa_status_change_09 %>% 
  filter(oa_status_august == "Closed" & str_detect(oa_status_september, "Green")) %>% 
  write_csv("data_intermediate/close2green_09.csv")

  
green_added_09 <- oa_status_change_09 %>% 
  filter(!str_detect(oa_status_august, "Green") & str_detect(oa_status_september, "Green"))

green_removed_09 <- oa_status_change_09 %>% 
  filter(str_detect(oa_status_august, "Green") & !str_detect(oa_status_september, "Green"))
```

Publications by Year & by OA Status (Data Retrieved on September 1)
```{r, September-OA-status}

# OA status in September
main_09 %>% 
  separate(oa_status_september, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(year) %>% 
  count(is_oa, oa_status) %>% 
  mutate(percent = 100*n/sum(n)) %>% 
  ungroup() %>% 
  qhpvt(
    c("is_oa","oa_status"), 
    "year", 
    c("Count" = "sum(n)", "%" = "sum(percent)"),
    formats = list("%.0f", "%.2f"),
    totals = list("is_oa" = "Total", "oa_status" = "Total"),
    totalStyle = list("font-weight"="bold")
    )
```
* Citations
  * Comparing with August, **1,822 items** obtained more citations.
  * Citations per paper(CpP) for OA publications was **32.26** while for closed publications was **around 11.36**. 

```{r, September-citations}


# Citations in September
citations_change_09 <- main_09 %>% 
  select(title, source_title, year, citations_august, citations_september) %>% 
  filter(citations_september-citations_august != 0) %>% 
  mutate(citations_diff = citations_september - citations_august, 
         citations_percentage = ifelse(
           citations_august != 0, (citations_september - citations_august)*100 / citations_august, ifelse(citations_august == 0, NA, 999))) %>% 
  arrange(desc(citations_diff), desc(citations_percentage))

citations_error_09 <- citations_change_09 %>% 
  select(title, source_title, year, citations_august, citations_september, citations_diff) %>%
  filter(citations_diff < 0)

citations_per_paper_09 <- main_09 %>%
  separate(oa_status_september, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(is_oa) %>% 
  mutate(CpP_09 = sum(citations_september)/n())
```
Citations by Year & by OA Status (Data Retrieved on September 1)

```{r, September-citations-per-paper}


# Citations per Paper in September
main_09 %>% 
  separate(oa_status_september, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(year, oa_status) %>% 
  mutate(citations_per_paper = round(sum(citations_september)/n())) %>%   # added a new column the citations per paper
  select(year, is_oa, oa_status, citations_september, citations_per_paper) %>%  
  ungroup() %>%  
  qhpvt(
    c("is_oa", "oa_status"), 
    "year", 
    c("Count" = "n()", "CpP" = "sum(citations_per_paper)/n()"),
    formats = list("%.0f", "%.0f"),
    totals = list("oa_status" = "Total", "Year" = "Total"),
    totalStyle = list("font-weight"="bold")
    )
```

## August
Scopus application is used to retrieve data on August 1st, 2022. 


```{r, August-data-preparation}

# read August data
scopus_august <- read_csv("data/scopus_20220801.csv")


# select only columns relevant
scopus_august <- scopus_august[c(1,3,4,5,12,13,15:17,19)]

# rename columns
names(scopus_august)[c(1:10)] <- c("author", "title", "year", "source_title", "citations_august", "DOI", "doc_type", "pub_stage", "oa_status_august", "EID")


# Replace NAs in citations and OA status, remove rows with missing or duplicated DOIs
scopus_august <- scopus_august %>% 
  replace_na(list(oa_status_august = "Closed", citations_august = 0)) %>% 
  filter(!is.na(DOI)) %>% 
  filter(!DOI %in% DOI[duplicated(DOI)]) %>% 
  write_csv("data_intermediate/scopus_august.csv")

# read July data
scopus_july <- read_csv("data_intermediate/scopus_july.csv")


# records removed from March
removed_08 <- anti_join(scopus_march, scopus_august, by = "DOI") 
removed_08 <- removed_08 %>%
  select(source_title, year, pub_stage, oa_status_march, DOI) %>% 
  arrange(source_title) %>% 
  write_csv("data_intermediate/removed_08.csv")

# new records in August
added_08 <- anti_join(scopus_august, scopus_march, by = "DOI") 

added_08 <- added_08 %>% 
  select(source_title, year, pub_stage, oa_status_august, DOI) %>%
  arrange(source_title)

# shared items of July and August
main_08 <- inner_join(scopus_july, scopus_august, by = "DOI")
main_08 <- main_08[-c(11:14, 16, 17, 19)]

names(main_08)[c(1:12)] <- c("author", "title", "year", "source_title", "citations_july", "DOI", "doc_type", "pub_stage", "oa_status_july", "EID", "citations_august", "oa_status_august")
```
* Number of records (Comparing with March)
  After removing records with missing DOIs or duplicated DOIs, **9,865 records** were kept. **23 items** were removed from the data set of March and **76 items** were added. The total data change was **around 1.0%**.
  
* OA Status (Comparing with July)
  * Comparing with July, the OA status of **98 items** changed. 29 OA items turned to be closed; while 18 items became open access. 
  * **30 items turned green where 8 of them were closed items in July**. 6 items lost their green status.

```{r, August-findings}

#---- Findings - OA Status ----
oa_status_change_08 <- main_08 %>% 
  select(title, source_title, year, oa_status_july, oa_status_august, DOI) %>% 
  filter(main_08$oa_status_july != main_08$oa_status_august) %>% 
  arrange(source_title) 

open2close_08 <- oa_status_change_08 %>% 
  filter(oa_status_august == "Closed") %>% 
  write_csv("data_intermediate/open2close_08.csv")

close2open_08 <- oa_status_change_08 %>% 
  filter(oa_status_july == "Closed")

# close2green_08 <- oa_status_change_08 %>% 
#   filter(oa_status_july == "Closed" & oa_status_august == "All Open Access, Green") %>% 
#   write_csv("data_intermediate/close2green_08.csv")


close2green_08 <- oa_status_change_08 %>% 
  filter(oa_status_july == "Closed" & str_detect(oa_status_august, "Green")) %>% 
  write_csv("data_intermediate/close2green_08.csv")

  
green_added_08 <- oa_status_change_08 %>% 
  filter(!str_detect(oa_status_july, "Green") & str_detect(oa_status_august, "Green"))

green_removed_08 <- oa_status_change_08 %>% 
  filter(str_detect(oa_status_july, "Green") & !str_detect(oa_status_august, "Green"))
```

Publications by Year & by OA Status (Data Retrieved on August 1)
```{r, August-OA-status}

# OA status in August
main_08 %>% 
  separate(oa_status_august, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(year) %>% 
  count(is_oa, oa_status) %>% 
  mutate(percent = 100*n/sum(n)) %>% 
  ungroup() %>% 
  qhpvt(
    c("is_oa","oa_status"), 
    "year", 
    c("Count" = "sum(n)", "%" = "sum(percent)"),
    formats = list("%.0f", "%.2f"),
    totals = list("is_oa" = "Total", "oa_status" = "Total"),
    totalStyle = list("font-weight"="bold")
    )
```
* Citations
  * Comparing with July, **3,013 items** obtained more citations.
  * Citations per paper(CpP) for OA publications was **over 31.8** while for closed publications was **around 11.1**. 

```{r, August-citations}


# Citations in August
citations_change_08 <- main_08 %>% 
  select(title, source_title, year, citations_july, citations_august) %>% 
  filter(citations_august-citations_july != 0) %>% 
  mutate(citations_diff = citations_august - citations_july, 
         citations_percentage = ifelse(
           citations_july != 0, (citations_august - citations_july)*100 / citations_july, ifelse(citations_july == 0, NA, 999))) %>% 
  arrange(desc(citations_diff), desc(citations_percentage))

citations_error_08 <- citations_change_08 %>% 
  select(title, source_title, year, citations_july, citations_august, citations_diff) %>%
  filter(citations_diff < 0)

citations_per_paper_08 <- main_08 %>%
  separate(oa_status_august, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(is_oa) %>% 
  mutate(CpP_08 = sum(citations_august)/n())
```
Citations by Year & by OA Status (Data Retrieved on August 1)

```{r, August-citations-per-paper}


# Citations per Paper in August
main_08 %>% 
  separate(oa_status_august, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(year, oa_status) %>% 
  mutate(citations_per_paper = round(sum(citations_august)/n())) %>%   # added a new column the citations per paper
  select(year, is_oa, oa_status, citations_august, citations_per_paper) %>%  
  ungroup() %>%  
  qhpvt(
    c("is_oa", "oa_status"), 
    "year", 
    c("Count" = "n()", "CpP" = "sum(citations_per_paper)/n()"),
    formats = list("%.0f", "%.0f"),
    totals = list("oa_status" = "Total", "Year" = "Total"),
    totalStyle = list("font-weight"="bold")
    )
```

## July
Scopus application is used to retrieve data on July 1st, 2022. 


```{r, July-data-preparation}

# read July data
scopus_july <- read_csv("data/scopus_20220701.csv")


# select only columns relevant
scopus_july <- scopus_july[c(1,3,4,5,12,13,15:17,19)]

# rename columns
names(scopus_july)[c(1:10)] <- c("author", "title", "year", "source_title", "citations_july", "DOI", "doc_type", "pub_stage", "oa_status_july", "EID")


# Replace NAs in citations and OA status, remove rows with missing or duplicated DOIs
scopus_july <- scopus_july %>% 
  replace_na(list(oa_status_july = "Closed", citations_july = 0)) %>% 
  filter(!is.na(DOI)) %>% 
  filter(!DOI %in% DOI[duplicated(DOI)]) %>% 
  write_csv("data_intermediate/scopus_july.csv")

# read June data
scopus_june <- read_csv("data_intermediate/scopus_june.csv")


# records removed from March
removed_07 <- anti_join(scopus_march, scopus_july, by = "DOI") 
removed_07 <- removed_07 %>%
  select(source_title, year, pub_stage, oa_status_march, DOI) %>% 
  arrange(source_title) %>% 
  write_csv("data_intermediate/removed_07.csv")

# new records in July
added_07 <- anti_join(scopus_july, scopus_march, by = "DOI") 

added_07 <- added_07 %>% 
  select(source_title, year, pub_stage, oa_status_july, DOI) %>%
  arrange(source_title)

# shared items of June and July
main_07 <- inner_join(scopus_june, scopus_july, by = "DOI")
main_07 <- main_07[-c(11:14, 16, 17, 19)]

names(main_07)[c(1:12)] <- c("author", "title", "year", "source_title", "citations_june", "DOI", "doc_type", "pub_stage", "oa_status_june", "EID", "citations_july", "oa_status_july")
```
* Number of records (Comparing with March)
  After removing records with missing DOIs or duplicated DOIs, **9,870 records** were kept. **18 items** were removed from the data set of March and **69 items** were added. The total data change was **around 0.9%**.
  
* OA Status (Comparing with June)
  * Comparing with June, the OA status of **80 items** changed. 19 OA items turned to be closed; while 20 items became open access. 
  * **28 items turned green where 15 of them were closed items in June**. 4 items lost their green status.

```{r, July-findings}

#---- Findings - OA Status ----
oa_status_change_07 <- main_07 %>% 
  select(title, source_title, year, oa_status_june, oa_status_july, DOI) %>% 
  filter(main_07$oa_status_june != main_07$oa_status_july) %>% 
  arrange(source_title) 

open2close_07 <- oa_status_change_07 %>% 
  filter(oa_status_july == "Closed") %>% 
  write_csv("data_intermediate/open2close_07.csv")

close2open_07 <- oa_status_change_07 %>% 
  filter(oa_status_june == "Closed")

# close2green_07 <- oa_status_change_07 %>% 
#   filter(oa_status_june == "Closed" & oa_status_july == "All Open Access, Green") %>% 
#   write_csv("data_intermediate/close2green_07.csv")


close2green_07 <- oa_status_change_07 %>% 
  filter(oa_status_june == "Closed" & str_detect(oa_status_july, "Green")) %>% 
  write_csv("data_intermediate/close2green_07.csv")

  
green_added_07 <- oa_status_change_07 %>% 
  filter(!str_detect(oa_status_june, "Green") & str_detect(oa_status_july, "Green"))

green_removed_07 <- oa_status_change_07 %>% 
  filter(str_detect(oa_status_june, "Green") & !str_detect(oa_status_july, "Green"))
```

Publications by Year & by OA Status (Data Retrieved on July 1)
```{r, July-OA-status}

# OA status in July
main_07 %>% 
  separate(oa_status_july, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(year) %>% 
  count(is_oa, oa_status) %>% 
  mutate(percent = 100*n/sum(n)) %>% 
  ungroup() %>% 
  qhpvt(
    c("is_oa","oa_status"), 
    "year", 
    c("Count" = "sum(n)", "%" = "sum(percent)"),
    formats = list("%.0f", "%.2f"),
    totals = list("is_oa" = "Total", "oa_status" = "Total"),
    totalStyle = list("font-weight"="bold")
    )
```
* Citations
  * Comparing with June, **1,388 items** obtained more citations.
  * Citations per paper(CpP) for OA publications was **over 30.5** while for closed publications was **around 10.7**. 

```{r, July-citations}


# Citations in July
citations_change_07 <- main_07 %>% 
  select(title, source_title, year, citations_june, citations_july) %>% 
  filter(citations_july-citations_june != 0) %>% 
  mutate(citations_diff = citations_july - citations_june, 
         citations_percentage = ifelse(
           citations_june != 0, (citations_july - citations_june)*100 / citations_june, ifelse(citations_june == 0, NA, 999))) %>% 
  arrange(desc(citations_diff), desc(citations_percentage))

citations_error_07 <- citations_change_07 %>% 
  select(title, source_title, year, citations_june, citations_july, citations_diff) %>%
  filter(citations_diff < 0)

citations_per_paper_07 <- main_07 %>%
  separate(oa_status_july, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(is_oa) %>% 
  mutate(CpP_07 = sum(citations_july)/n())
```
Citations by Year & by OA Status (Data Retrieved on July 1)

```{r, July-citations-per-paper}


# Citations per Paper in July
main_07 %>% 
  separate(oa_status_july, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(year, oa_status) %>% 
  mutate(citations_per_paper = round(sum(citations_july)/n())) %>%   # added a new column the citations per paper
  select(year, is_oa, oa_status, citations_july, citations_per_paper) %>%  
  ungroup() %>%  
  qhpvt(
    c("is_oa", "oa_status"), 
    "year", 
    c("Count" = "n()", "CpP" = "sum(citations_per_paper)/n()"),
    formats = list("%.0f", "%.0f"),
    totals = list("oa_status" = "Total", "Year" = "Total"),
    totalStyle = list("font-weight"="bold")
    )
```

## June
Scopus application is used to retrieve data on June 4th, 2022. 


```{r, June-data-preparation}

# read June data
scopus_june <- read_csv("data/scopus_20220604.csv")


# select only columns relevant
scopus_june <- scopus_june[c(1,3,4,5,12,13,15:17,19)]

# rename columns
names(scopus_june)[c(1:10)] <- c("author", "title", "year", "source_title", "citations_june", "DOI", "doc_type", "pub_stage", "oa_status_june", "EID")


# Replace NAs in citations and OA status, remove rows with missing or duplicated DOIs
scopus_june <- scopus_june %>% 
  replace_na(list(oa_status_june = "Closed", citations_june = 0)) %>% 
  filter(!is.na(DOI)) %>% 
  filter(!DOI %in% DOI[duplicated(DOI)]) %>% 
  write_csv("data_intermediate/scopus_june.csv")

# read May data
scopus_may <- read_csv("data_intermediate/scopus_may.csv")


# records removed from March
removed_06 <- anti_join(scopus_march, scopus_june, by = "DOI") 
removed_06 <- removed_06 %>%
  select(source_title, year, pub_stage, oa_status_march, DOI) %>% 
  arrange(source_title) %>% 
  write_csv("data_intermediate/removed_06.csv")

# new records in June
added_06 <- anti_join(scopus_june, scopus_march, by = "DOI") 

added_06 <- added_06 %>% 
  select(source_title, year, pub_stage, oa_status_june, DOI) %>% 
  arrange(source_title)

# shared items of May and June
main_06 <- inner_join(scopus_may, scopus_june, by = "DOI")
main_06 <- main_06[-c(11:14, 16, 17, 19)]

names(main_06)[c(1:12)] <- c("author", "title", "year", "source_title", "citations_may", "DOI", "doc_type", "pub_stage", "oa_status_may", "EID", "citations_june", "oa_status_june")
```
* Number of records (Comparing with March)
  After removing records with missing DOIs or duplicated DOIs, 9,860 records were kept. 17 items were removed from the data set of March and 58 items were added. The total data change was around 0.8%.
  
* OA Status (Comparing with May)
  * Comparing with May, the OA status of **120 items** changed. 20 OA items turned to be closed; while 15 items became open access. 
  * **56 items turned green where 7 of them were closed items in May**. 7 items lost their green status.

```{r, June-findings}

#---- Findings - OA Status ----
oa_status_change_06 <- main_06 %>% 
  select(title, source_title, year, oa_status_may, oa_status_june, DOI) %>% 
  filter(main_06$oa_status_may != main_06$oa_status_june) %>% 
  arrange(source_title) 

open2close_06 <- oa_status_change_06 %>% 
  filter(oa_status_june == "Closed") %>% 
  write_csv("data_intermediate/open2close_06.csv")

close2open_06 <- oa_status_change_06 %>% 
  filter(oa_status_may == "Closed")

close2green_06 <- oa_status_change_06 %>% 
  filter(oa_status_may == "Closed" & oa_status_june == "All Open Access, Green") %>% 
  write_csv("data_intermediate/close2green_06.csv")
  
green_added_06 <- oa_status_change_06 %>% 
  filter(!str_detect(oa_status_may, "Green") & str_detect(oa_status_june, "Green"))

green_removed_06 <- oa_status_change_06 %>% 
  filter(str_detect(oa_status_may, "Green") & !str_detect(oa_status_june, "Green"))
```

Publications by Year & by OA Status (Data Retrieved on May 2)
```{r, June-OA-status}

# OA status in June
main_06 %>% 
  separate(oa_status_june, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(year) %>% 
  count(is_oa, oa_status) %>% 
  mutate(percent = 100*n/sum(n)) %>% 
  ungroup() %>% 
  qhpvt(
    c("is_oa","oa_status"), 
    "year", 
    c("Count" = "sum(n)", "%" = "sum(percent)"),
    formats = list("%.0f", "%.2f"),
    totals = list("is_oa" = "Total", "oa_status" = "Total"),
    totalStyle = list("font-weight"="bold")
    )
```
* Citations
  * Comparing with May, 2,476 items obtained more citations.
  * Citations per paper(CpP) for OA publications was over 30 while for closed publications was around 10.5. 

```{r, June-citations}


# Citations in June
citations_change_06 <- main_06 %>% 
  select(title, source_title, year, citations_may, citations_june) %>% 
  filter(citations_june-citations_may != 0) %>% 
  mutate(citations_diff = citations_june - citations_may, 
         citations_percentage = ifelse(
           citations_may != 0, (citations_june - citations_may)*100 / citations_may, ifelse(citations_may == 0, NA, 999))) %>% 
  arrange(desc(citations_diff), desc(citations_percentage))

citations_error_06 <- citations_change_06 %>% 
  select(title, source_title, year, citations_may, citations_june, citations_diff) %>%
  filter(citations_diff < 0)

citations_per_paper_06 <- main_06 %>%
  separate(oa_status_june, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(is_oa) %>% 
  mutate(CpP_06 = sum(citations_june)/n())
```
Citations by Year & by OA Status (Data Retrieved on June 4)

```{r, June-citations-per-paper}


# Citations per Paper in June
main_06 %>% 
  separate(oa_status_june, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(year, oa_status) %>% 
  mutate(citations_per_paper = round(sum(citations_june)/n())) %>%   # added a new column the citations per paper
  select(year, is_oa, oa_status, citations_june, citations_per_paper) %>%  
  ungroup() %>%  
  qhpvt(
    c("is_oa", "oa_status"), 
    "year", 
    c("Count" = "n()", "CpP" = "sum(citations_per_paper)/n()"),
    formats = list("%.0f", "%.0f"),
    totals = list("oa_status" = "Total", "Year" = "Total"),
    totalStyle = list("font-weight"="bold")
    )
```

## May
Scopus application is used to retrieve data on May 2nd, 2022. 

```{r, May-data-preparation}

# read April data
scopus_april <- read_csv("data/scopus_20220419.csv")


# select only columns relevant
scopus_april <- scopus_april[c(1,3,4,5,12,13,15:17,19)]

# rename columns
names(scopus_april)[c(1:10)] <- c("author", "title", "year", "source_title", "citations_april", "DOI", "doc_type", "pub_stage", "oa_status_april", "EID")


# Replace NAs in citations and OA status, remove rows with missing or duplicated DOIs
scopus_april <- scopus_april %>% 
  replace_na(list(oa_status_april = "Closed", citations_april = 0)) %>% 
  filter(!is.na(DOI)) %>% 
  filter(!DOI %in% DOI[duplicated(DOI)]) %>% 
  write_csv("data_intermediate/scopus_april.csv")

# read May data
scopus_may <- read_csv("data/scopus_20220502.csv")


# select only columns relevant
scopus_may <- scopus_may[c(1,3,4,5,12,13,15:17,19)]

# rename columns
names(scopus_may)[c(1:10)] <- c("author", "title", "year", "source_title", "citations_may", "DOI", "doc_type", "pub_stage", "oa_status_may", "EID")


# Replace NAs in citations and OA status, remove rows with missing or duplicated DOIs
scopus_may <- scopus_may %>% 
  replace_na(list(oa_status_may = "Closed", citations_may = 0)) %>% 
  filter(!is.na(DOI)) %>% 
  filter(!DOI %in% DOI[duplicated(DOI)]) %>% 
  write_csv("data_intermediate/scopus_may.csv")

# records removed from March
removed_05 <- anti_join(scopus_march, scopus_may, by = "DOI") 
removed_05 <- removed_05 %>%
  select(source_title, year, pub_stage, oa_status_march, DOI) %>% 
  arrange(source_title)

# new records in May
added_05 <- anti_join(scopus_may, scopus_march, by = "DOI") 

added_05 <- added_05 %>% 
  select(source_title, year, pub_stage, oa_status_may, DOI) %>% 
  arrange(source_title)

# shared items of April and May
main_05 <- inner_join(scopus_april, scopus_may, by = "DOI")
main_05 <- main_05[-c(11:14, 16, 17, 19)]

names(main_05)[c(1:12)] <- c("author", "title", "year", "source_title", "citations_april", "DOI", "doc_type", "pub_stage", "oa_status_april", "EID", "citations_may", "oa_status_may")
```
* Number of records (Comparing with March)
  After removing records with missing DOIs or duplicated DOIs, 9,852 records were kept. 14 items were removed from the data set of March and 47 items were added. The total data change was around 0.6%.
  
* OA Status (Comparing with April)
  * Comparing with April, 3 OA items turned to be closed; while 9 items became open access. 
  * **14 items turned green where 5 of them were closed items in April**. 3 items lost their green status.

```{r, May-findings}

#---- Findings - OA Status ----
oa_status_change_05 <- main_05 %>% 
  select(title, source_title, year, oa_status_april, oa_status_may, DOI) %>% 
  filter(oa_status_april != oa_status_may) %>% 
  arrange(source_title)

open2close_05 <- oa_status_change_05 %>% 
  filter(oa_status_may == "Closed")

close2open_05 <- oa_status_change_05 %>% 
  filter(oa_status_april == "Closed")

close2green_05 <- oa_status_change_05 %>% 
  filter(oa_status_april == "Closed" & oa_status_may == "All Open Access, Green")
  
green_added_05 <- oa_status_change_05 %>% 
  filter(!str_detect(oa_status_april, "Green") & str_detect(oa_status_may, "Green"))

green_removed_05 <- oa_status_change_05 %>% 
  filter(str_detect(oa_status_april, "Green") & !str_detect(oa_status_may, "Green"))
```

Publications by Year & by OA Status (Data Retrieved on May 2)
```{r, May-OA-status}

# OA status in May
main_05 %>% 
  separate(oa_status_may, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(year) %>% 
  count(is_oa, oa_status) %>% 
  mutate(percent = 100*n/sum(n)) %>% 
  ungroup() %>% 
  qhpvt(
    c("is_oa","oa_status"), 
    "year", 
    c("Count" = "sum(n)", "%" = "sum(percent)"),
    formats = list("%.0f", "%.2f"),
    totals = list("is_oa" = "Total", "oa_status" = "Total"),
    totalStyle = list("font-weight"="bold")
    )
```
* Citations
  * Comparing with April, 1,003 items obtained more citations.
  * Citations per paper(CpP) for OA publications was almost 30 while for closed publications was a little bit over 10. 

```{r, May-citations}


# Citations in May
citations_change_05 <- main_05 %>% 
  select(title, source_title, year, citations_april, citations_may) %>% 
  filter(citations_may-citations_april != 0) %>% 
  mutate(citations_diff = citations_may - citations_april, 
         citations_percentage = ifelse(
           citations_april != 0, (citations_may - citations_april)*100 / citations_april, ifelse(citations_april == 0, NA, 999))) %>% 
  arrange(desc(citations_diff), desc(citations_percentage))

citations_error_05 <- citations_change_05 %>% 
  select(title, source_title, year, citations_april, citations_may, citations_diff) %>% 
  filter(citations_diff < 0)

citations_per_paper_05 <- main_05 %>%
  separate(oa_status_may, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(is_oa) %>% 
  mutate(CpP_05 = sum(citations_may)/n())

```
Citations by Year & by OA Status (Data Retrieved on May 2)

```{r, May-citations-per-paper}


# Citations per Paper in May
main_05 %>% 
  separate(oa_status_may, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(year, oa_status) %>% 
  mutate(citations_per_paper = round(sum(citations_may)/n())) %>%   # added a new column the citations per paper
  select(year, is_oa, oa_status, citations_may, citations_per_paper) %>%  
  ungroup() %>%  
  qhpvt(
    c("is_oa", "oa_status"), 
    "year", 
    c("Count" = "n()", "CpP" = "sum(citations_per_paper)/n()"),
    formats = list("%.0f", "%.0f"),
    totals = list("oa_status" = "Total", "Year" = "Total"),
    totalStyle = list("font-weight"="bold")
    )
```


## April

Both Scopus API and the application Scopus are used to retrieve the OA status and citation counts. The same data set as last month was used to acquire data through Scopus API. The application Scopus can find not only items moved out of Scopus but new items added to Scopus. The application Scopus will be used from May and the March data will be used as the benchmark for comparison. 

```{r, April-data-preparation}


#---- Prepare data for analysis ----
scopus_202203_1 <- read_csv("data/scopus_2016_20220301.csv")
scopus_202203_2 <- read_csv("data/scopus_2017_20220301.csv")
scopus_202203_3 <- read_csv("data/scopus_2018_20220301.csv")
scopus_202203_4 <- read_csv("data/scopus_2019_20220301.csv")
scopus_202203_5 <- read_csv("data/scopus_2020_20220301.csv")

# combine all the 5 files into 1
scopus_march <- rbind(scopus_202203_1, scopus_202203_2, scopus_202203_3, scopus_202203_4, scopus_202203_5)

# select only columns relevant
scopus_march <- scopus_march[c(1,3,4,5,12,13,15:17,19)]

# test <- filter(scopus_march, !is.na(DOI)) # remove records with missing DOIs

# remove records with duplicated DOIs, several solutions on the page - https://stackoverflow.com/questions/32259620/how-to-remove-unique-entry-and-keep-duplicates-in-r

# solution 1 - the following 2 lines, but do not understand
# test_2 <- test[unlist(tapply(1:nrow(test), test$DOI, function(x) if (length(x) > 1)x)), ]
# test <- test %>% anti_join(test_2)

# solution 2 
# test_4 <- test[!test$DOI %in% test$DOI[duplicated(test$DOI)],]

# solution 3 - cannot use == or != here, but do not understand why
# test_5 <- filter(test, !DOI %in%  DOI[duplicated(DOI)])

# solution 4 
# test_6 <- test %>% group_by(DOI) %>% filter(n() == 1)


#rename columns
names(scopus_march)[c(1:10)] <- c("author", "title", "year", "source_title", "citations_march", "DOI", "doc_type", "pub_stage", "oa_status_march", "EID")

# Replace NAs in citations and OA status, remove rows with missing or duplicated DOIs
scopus_march <- scopus_march %>% 
  replace_na(list(oa_status_march = "Closed", citations_march = 0)) %>% 
  filter(!is.na(DOI)) %>% 
  filter(!DOI %in% DOI[duplicated(DOI)])


# read April data
scopus_april <- read_csv("data/scopus_20220419.csv")


# select only columns relevant
scopus_april <- scopus_april[c(1,3,4,5,12,13,15:17,19)]

# rename columns
names(scopus_april)[c(1:10)] <- c("author", "title", "year", "source_title", "citations_april", "DOI", "doc_type", "pub_stage", "oa_status_april", "EID")


# Replace NAs in citations and OA status, remove rows with missing or duplicated DOIs
scopus_april <- scopus_april %>% 
  replace_na(list(oa_status_april = "Closed", citations_april = 0)) %>% 
  filter(!is.na(DOI)) %>% 
  filter(!DOI %in% DOI[duplicated(DOI)])
```
* Number of records
    * The search of 03/01/2022 kept 9,819 records after removing those with duplicated  or missing DOIs.
    * The search of 04/19/2022 kept 9,854 records. Comparing with the data from last month, 11 records were moved out from the Scopus databases and 46 records were added. The total data change was around 0.6% this month. 

```{r, April-findings}

#---- Findings - Number of Items ----
# records removed from March
removed <- anti_join(scopus_march, scopus_april, by = "DOI") 
removed <- removed %>%
  select(source_title, year, pub_stage, oa_status_march, DOI) %>% 
  arrange(source_title)

# new records in April
added <- anti_join(scopus_april, scopus_march, by = "DOI") 

added <- added %>% 
  select(source_title, year, pub_stage, oa_status_april, DOI) %>% 
  arrange(source_title)

main <- inner_join(scopus_march, scopus_april, by = "DOI")
main <- main[-c(11:14, 16, 17, 19)]

names(main)[c(1:12)] <- c("author", "title", "year", "source_title", "citations_march", "DOI", "doc_type", "pub_stage", "oa_status_march", "EID", "citations_april", "oa_status_april")
```
* OA Status

    * In April, **24 OA items turned to be closed**, and **33 closed items became open access**.
    * In total, **35 items were added to repositories**, turned to be green, while **14 items lost their "green" status**. 
    * The following two tables show the number of publications by year and by OA status. Data of April came first, followed with data of March. All the data retrieved through Scopus application. 

```{r, April-OA-status-1}

#---- Findings - OA Status ----
oa_status_change <- main %>% 
  select(title, source_title, year, oa_status_march, oa_status_april, DOI) %>% 
  filter(main$oa_status_march != main$oa_status_april) %>% 
  arrange(source_title)

open2close <- oa_status_change %>% 
  filter(oa_status_april == "Closed")

close2open <- oa_status_change %>% 
  filter(oa_status_march == "Closed")

close2green <- oa_status_change %>% 
  filter(oa_status_march == "Closed" & oa_status_april == "All Open Access, Green")
  
green_added <- oa_status_change %>% 
  filter(!str_detect(oa_status_march, "Green") & str_detect(oa_status_april, "Green"))

green_removed <- oa_status_change %>% 
  filter(str_detect(oa_status_march, "Green") & !str_detect(oa_status_april, "Green"))
```
OA Status Data Retrieved on April 19 (Scopus Application)

```{r, April-OA-status-2}

# OA status in April
main %>% 
  separate(oa_status_april, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(year) %>% 
  count(is_oa, oa_status) %>% 
  mutate(percent = 100*n/sum(n)) %>% 
  ungroup() %>% 
  qhpvt(
    c("is_oa","oa_status"), 
    "year", 
    c("Count" = "sum(n)", "%" = "sum(percent)"),
    formats = list("%.0f", "%.2f"),
    totals = list("is_oa" = "Total", "oa_status" = "Total"),
    totalStyle = list("font-weight"="bold")
    )
```
OA Status Data Retrieved on March 1 (Scopus Application)

```{r, March-OA-status}

# OA status in March
main %>% 
  separate(oa_status_march, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(year) %>% 
  count(is_oa, oa_status) %>% 
  mutate(percent = 100*n/sum(n)) %>% 
  ungroup() %>% 
  qhpvt(
    c("is_oa","oa_status"), 
    "year", 
    c("Count" = "sum(n)", "%" = "sum(percent)"),
    formats = list("%.0f", "%.2f"),
    totals = list("is_oa" = "Total", "oa_status" = "Total"),
    totalStyle = list("font-weight"="bold")
    ) 


```
* Citations
    * Comparing the data of April and March, 3,236 publications got more citations, while *9 items saw a decrease in citation counts*.
    * No big changes in Citations per Paper (CpP) from March to April. CpP for OA publication was around 28 while that for closed publication was almost 10. 
    * The following two tables show the Citations per Paper (CpP) by year and by OA status. Data of April came first, followed with data of March. All the data retrieved through Scopus application. 

```{r, April-citations}

#---- Findings - Citation Counts ----
citations_change <- main %>% 
  select(title, source_title, year, citations_march, citations_april) %>% 
  filter(citations_april-citations_march != 0) %>% 
  mutate(citations_diff = citations_april - citations_march, 
         citations_percentage = ifelse(
           citations_march != 0, (citations_april - citations_march)*100 / citations_march, ifelse(citations_march == 0, NA, 999))) %>% 
  arrange(desc(citations_diff), desc(citations_percentage))

citations_error <- citations_change %>% 
  select(title, source_title, year, citations_march, citations_april, citations_diff) %>% 
  filter(citations_diff < 0)

citations_per_paper_04 <- main %>%
  separate(oa_status_april, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(is_oa) %>% 
  mutate(CpP_04 = sum(citations_april)/n()) %>% 
  select(CpP_04)

citations_per_paper_03 <- main %>%
  separate(oa_status_march, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(is_oa) %>% 
  mutate(CpP_03 = sum(citations_march)/n()) %>% 
  select(CpP_03)

top_400_diff <- main %>% 
  select(title, source_title, year, citations_march, citations_april) %>% 
  mutate(citations_diff = citations_april - citations_march, 
         citations_percentage = ifelse(
           citations_march != 0, (citations_april - citations_march)*100 / citations_march, ifelse(citations_march == 0, NA, 999))) %>% 
  arrange(desc(citations_diff)) %>% 
  head(400)

top_400_diff_percentage <- main %>% 
  select(title, source_title, year, citations_march, citations_april) %>% 
  mutate(citations_diff = citations_april - citations_march, 
         citations_percentage = ifelse(
           citations_march != 0, (citations_april - citations_march)*100 / citations_march, ifelse(citations_march == 0, NA, 999))) %>% 
  arrange(desc(citations_percentage)) %>% 
  head(400)

top_increase <- inner_join(top_400_diff, top_400_diff_percentage)
```

Citations Data Retrieved on April 19 (Scopus Application)
```{r, April-citations-per-paper}

# Citations per Paper in April
main %>% 
  separate(oa_status_april, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(year, oa_status) %>% 
  mutate(citations_per_paper = round(sum(citations_april)/n())) %>%   # added a new column the citations per paper
  select(year, is_oa, oa_status, citations_april, citations_per_paper) %>%  
  ungroup() %>%  
  qhpvt(
    c("is_oa", "oa_status"), 
    "year", 
    c("Count" = "n()", "CpP" = "sum(citations_per_paper)/n()"),
    formats = list("%.0f", "%.0f"),
    totals = list("oa_status" = "Total", "Year" = "Total"),
    totalStyle = list("font-weight"="bold")
    )
```
Citations Data Retrieved on March 1 (Scopus Application)

```{r, March-citations-per-paper}

# Citations per Paper in March
main %>% 
  separate(oa_status_march, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(year, oa_status) %>% 
  mutate(citations_per_paper = round(sum(citations_march)/n())) %>%   # added a new column the citations per paper
  select(year, is_oa, oa_status, citations_march, citations_per_paper) %>%  
  ungroup() %>%  
  qhpvt(
    c("is_oa", "oa_status"), 
    "year", 
    c("Count" = "n()", "CpP" = "sum(citations_per_paper)/n()"),
    formats = list("%.0f", "%.0f"),
    totals = list("oa_status" = "Total", "Year" = "Total"),
    totalStyle = list("font-weight"="bold")
    ) 

# write_csv(removed, "data_output/removed_april.csv")
# write_csv(close2green, "data_output/closed2green.csv")
# write_csv(open2close, "data_output/open2close.csv")

```
    
## March

Comparing the OA status information from Scopus and Unpaywall:

* The total OA counts were almost the same;
* The counts of specific OA status were different. If we could not quickly identify which source is more reliable, I suggested we use Scopus OA data because it is easier and less time-consuming to obtain.
* The **overall journal article OA percentage was 45%** and **conference proceedings was around 10%**. 
* **Citations per paper** for closed publication were **10**; while for **green or gold OA publications** were around **20**. 
* Scopus updates its data constantly. The data retrieved on March 1st and March 3rd using the same query were a little bit different. Next month, I will try to use the **Scopus API** to track the OA status and citations for the data set of 10,498 records (retrieved on March 1st, 2022). 

<br>

The following table shows the count and percentage by OA status and year.

```{r, March-OA-status-2}

# install.packages("qwraps2") # not used
# install.packages("gt") # not used
# install.packages("pivottabler")

library(tidyverse)
library(pivottabler)

oa_stats_march <- read_csv("data/oa_stats_20220301_clean.csv")

# qhpvt(oa_stats_march, c("is_oa","oa_status"), "Year", "n()") this code works for count, but not for percentage

oa4pivot <- oa_stats_march %>% 
  group_by(Year) %>% 
  count(is_oa, oa_status) %>%  
  mutate(percent = 100*n/sum(n)) %>%   # calculate the percentage
  ungroup() 

oa4pivot$is_oa <- as.character(oa4pivot$is_oa)  #convert is_oa from logic to character

oa4pivot %>%   
  qhpvt(
    c("is_oa","oa_status"), 
    "Year", 
    c("Count" = "sum(n)", "%" = "sum(percent)"),
    formats = list("%.0f", "%.2f"),
    totals = list("is_oa" = "Total", "oa_status" = "Total"),
    totalStyle = list("font-weight"="bold")
    )

# not sure how to remove the Total column for Year
# pt <- PivotTable$new()
# pt$addData(oa4pivot)
# pt$addColumnDataGroups("Year")
# pt$addRowDataGroups("is_oa", 
#                     outlineTotal=list(groupStyleDeclarations=list(color="black")))
# pt$addRowDataGroups("oa_status",
#                     outlineTotal=list(groupStyleDeclarations=list(color="black")))
# pt$defineCalculation(calculationName = "count", summariseExpression = "sum(n)")
# pt$defineCalculation(calculationName = "%", summariseExpression = "round(sum(percent))")
# pt$renderPivot()

```
The table below showed the citations per paper by OA status and year: 
```{r, March-OA-status-3}

citations <- oa_stats_march
citations$Cited_by[is.na(citations$Cited_by) == TRUE] <- 0
citations$is_oa <- as.character(citations$is_oa)  #convert is_oa from logic to character

citations %>% 
  group_by(Year, oa_status) %>% 
  mutate(citations_per_paper = round(sum(Cited_by)/n())) %>%   # added a new column the citations per paper
  select(Year, is_oa, oa_status, Cited_by, citations_per_paper) %>%  
  ungroup() %>%  
  qhpvt(
    c("is_oa", "oa_status"), 
    "Year", 
    c("Count" = "n()", "Citations Per Paper" = "sum(citations_per_paper)/n()"),
    formats = list("%.0f", "%.0f"),
    totals = list("oa_status" = "Total", "Year" = "Total"),
    totalStyle = list("font-weight"="bold")
    )


```

# Web Stats

Comparing Jan and Feb of the four years from 2019 to 2022

## Google Analytics

### March

#### Overview

The page views of the **study spaces page** have **tripled to nearly 10,000 since 2019**. The mobile visits increased from 1,000 to about 5,000 now. **The mobile usage takes almost half of the page views of this page**. 

Comparing with the pandemic time, Jan through March of 2021(blue line), the website visits **increased around 20% in 2022**. The current page views are still **20-30% lower than those before the COVID-19**. 

<br>
![](images/pageview_jan-mar_2019-2022.png)

*Note*

* The page views of library website fluctuate on a weekly basis. The x-axis uses the date of the year 2022. The page views of other year are switched to match the fluctuation and demo the differences by year.
* The second half week of 02/05 in 2022 and the week of 02/19 in 2021, the city was hit by winter storms and the campus was closed.
* The week of 03/12 in 2019 and the week of 03/19 in 2020 & 2022 were spring breaks. 

#### Organic search vs Direct visit
* For the most visited pages like study space, ETD, books, personal librarians, doc del, and accounts, over 65% of visits came from organic searches. 

#### Desktop vs Mobile
* Most pages are still viewed on desktops. 
* Certain pages have obtained more mobile users. The mobile views of the parking and Wi-Fi pages have increased from around 65% to 77% since 2019.
* The use of tablets seems declining.

### Feb
**The overall usage of website increases comparing with the same time period of 2021, but has not come back to the level of 2019 and 2020 (pre-pandemic). **

**Home page clicks - The label [object HTMLDivElement]tab_overlay[object Object] takes over 7% of the clicks but I could not identify the element. Probably this label is for some spots on the search boxes. If true, the search box area got over 60% of the clicks. Need to follow up with this label. **


* Browsers: 65-70% sessions used Chrome; usage of Safari was slightly increased
* Channels: The percentage of sessions which came through organic searches increased from 43% to 60% in 2021 and 58% in 2022. Even before COVID-19, use of organic search was increasing. The pandemic accelerated this trend. 
* Devices: Sessions using desktop have gradually moved to mobile during 2019 through 2021. But 2022 witnessed a jump from 9% to 13% in mobile and a drop from 90% to 84% in desktop. Will follow up to see if it is a new trend. 

```{r, Feb-GA}
# # library(tidyverse)
# # library(pivottabler)
# 
# pageviews <- read_csv("data/pageviews.csv")
# 
# ## pageviews %>% 
# ##   qhpvt("Name", "Year", "sum(Pageviews)")
# 
# 
# pt <- PivotTable$new()
# pt$addData(pageviews)
# pt$addColumnDataGroups("Year")
# pt$addRowDataGroups("Name", 
#                     outlineTotal=list(groupStyleDeclarations=list(color="black")))
# pt$defineCalculation(calculationName = "TotalViews", summariseExpression = "sum(Pageviews)")
# pt$sortRowDataGroups(
#   levelNumber = 1,
#   orderBy = "calculation",
#   sortOrder = "desc",
#   calculationGroupName = "default"
# )
# ## pt$asDataFrame()
# pt$renderPivot()


```

## Google Business Profile

* Profile on Google Reviews
  * Oct - 3 reviews received, all were rated 5 stars. 
  * Sep - 3 reviews received, two were 5-star and one was 4-star. The user pointed out that if you don't pick the right elevator, you may get lost. 
  * Aug - No new reviews.
  * Jul - 1 review received, it was rated 5 stars.
  * Jun - 3 reviews received, all were 5-star ratings.
  * May - No new reviews. 
  * Apr - 2 reviews received, both were 5-star ratings.
  * Mar - 5 reviews received, all were 5-star ratings.
  * Jan and Feb - 4 reviews received, two were 5-star and other two reviews were 4-star ratings
* Profile views 
  * Oct - 22,484
  * Sep - 24,465
  * Aug - 16,846
  * Jul - 11,633
  * Jun - 15,007
  * May - 16,669
  * Apr - 22,180
  * Mar - 25,049 
  * Feb - 24,093
  * Jan - 17,910
* Over 70% of the Google searches were preformed on desktop; while the rest were on mobile. The percentage of searches using desktop computers have slightly decreased since last fall.   


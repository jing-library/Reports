---
title: "Stats 2023"
output: 
  html_document: 
    toc: true
    toc_float: true
    collapsed: false
    number_sections: false
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE,warning=FALSE, cache=TRUE)

#install.packages("pivottabler")
library(tidyverse)
library(pivottabler)
```


# OA Stats
This section is to track the OA status and citation counts of publications by the Tech authors with the publication dates from 2016 through 2020. 

```{r 2022-March-data-as-baseline}

#---- Prepare March data for analysis ----
scopus_202203_1 <- read_csv("data/scopus_2016_20220301.csv")
scopus_202203_2 <- read_csv("data/scopus_2017_20220301.csv")
scopus_202203_3 <- read_csv("data/scopus_2018_20220301.csv")
scopus_202203_4 <- read_csv("data/scopus_2019_20220301.csv")
scopus_202203_5 <- read_csv("data/scopus_2020_20220301.csv")

# combine all the 5 files into 1
scopus_2022_march <- rbind(scopus_202203_1, scopus_202203_2, scopus_202203_3, scopus_202203_4, scopus_202203_5)
rm(scopus_202203_1, scopus_202203_2,scopus_202203_3,scopus_202203_4,scopus_202203_5)

# select only columns relevant
scopus_2022_march <- scopus_2022_march[c(1,3,4,5,12,13,15:17,19)]

#rename columns
names(scopus_2022_march)[c(1:10)] <- c("author", "title", "year", "source_title", "citations_2022_march", "DOI", "doc_type", "pub_stage", "oa_status_2022_march", "EID")

# Replace NAs in citations and OA status, remove rows with missing or duplicated DOIs
scopus_2022_march <- scopus_2022_march %>% 
  replace_na(list(oa_status_2022_march = "Closed", citations_2022_march = 0)) %>% 
  filter(!is.na(DOI)) %>% 
  filter(!DOI %in% DOI[duplicated(DOI)])

```

## 2023 June
Data was retrieved from Scopus on June 2nd, 2023. It seemed that Scopus made some changes in their bibliographic data (csv):
* Data quality improved - CSV files can be opened without errors. I had to manually fix mismatched cells in MS Excel.
* A new column "Author Full Name" is added
* OA Status: 
** "Open Access" is added to each OA status, for example, "Gold" became "Gold Open Access" this month
** alphabetically ordered
** separator changed from "," to ";"


```{r, 2023-June-data-preparation}

# read June data
scopus_2023_june <- read_csv("data/scopus_20230602.csv")


# select only columns relevant
scopus_2023_june <- scopus_2023_june[c(1,4,5,6,13,14,16:18,20)]

# rename columns
names(scopus_2023_june)[c(1:10)] <- c("author", "title", "year", "source_title", "citations_2023_june", "DOI", "doc_type", "pub_stage", "oa_status_2023_june", "EID")


# Replace NAs in citations and OA status, remove rows with missing or duplicated DOIs
scopus_2023_june <- scopus_2023_june %>% 
  replace_na(list(oa_status_2023_june = "Closed", citations_2023_june = 0)) %>% 
  filter(!is.na(DOI)) %>% 
  filter(!DOI %in% DOI[duplicated(DOI)]) %>% 
  write_csv("data_intermediate/scopus_2023_june.csv")

# read May data
scopus_2023_may <- read_csv("data_intermediate/scopus_2023_may.csv")


# records removed from 2022 March
removed_202306 <- anti_join(scopus_2022_march, scopus_2023_june, by = "DOI") 
removed_202306 <- removed_202306 %>%
  select(source_title, year, pub_stage, oa_status_2022_march, DOI) %>% 
  arrange(source_title) %>% 
  write_csv("data_intermediate/removed_202306.csv")

# new records in 2023 June
added_202306 <- anti_join(scopus_2023_june, scopus_2022_march, by = "DOI") 

added_202306 <- added_202306 %>% 
  select(source_title, year, pub_stage, oa_status_2023_june, DOI) %>%
  arrange(source_title)

# shared items of 2023 May and 2023 June
main_202306 <- inner_join(scopus_2023_may, scopus_2023_june, by = "DOI")
main_202306 <- main_202306[-c(11:14, 16, 17, 19)]

names(main_202306)[c(1:12)] <- c("author", "title", "year", "source_title", "citations_2023_may", "DOI", "doc_type", "pub_stage", "oa_status_2023_may", "EID", "citations_2023_june", "oa_status_2023_june")
```
* Number of records (Comparing with 2022 March)
  After removing records with missing DOIs or duplicated DOIs, **9,917 records** were kept. **75 items** were removed from the data set of March 2022 and **173 items** were added. The total data change was **around 2.5%**.
  
* OA Status (Comparing with 2023 May)
  * Comparing with 2023 May, **489 items** changed their OA status. **Ten** OA items turned to be closed and **186** closed items became open access. 
  * **138 item turned green where 31 of them were closed items in May**. **12** items lost their green status.

```{r, 2023-June-findings}

#---- Findings - OA Status ----

# Scopus changed the "OA Status" in data from "Green" to "Green Open Access", from "Hybrid Gold" to "Hybrid Gold Open Access", from "Gold" to "Gold Open Access", and from "Bronze" to "Bronze Open Access". Update the column oa_status_2023_june by removing "Open Access" for comparison purposes

main_202306 <- main_202306 %>% 
  mutate(oa_status_2023_june = str_replace(oa_status_2023_june, "Hybrid Gold Open Access","Hybrid Gold")) %>%
  mutate(oa_status_2023_june = str_replace(oa_status_2023_june, "Gold Open Access","Gold")) %>% 
  mutate(oa_status_2023_june = str_replace(oa_status_2023_june, "Green Open Access","Green")) %>%
  mutate(oa_status_2023_june = str_replace(oa_status_2023_june, "Bronze Open Access","Bronze")) %>% 
  mutate(oa_status_2023_june = str_replace(oa_status_2023_june, ";",",")) %>% 
  mutate(oa_status_2023_june = str_replace(oa_status_2023_june, ";",",")) 

# df$Modules <- sapply(strsplit(as.character(df$Modules), ',\\s*'), function(x) toString(sort(x)))

main_202306$oa_status_2023_may <- sapply(strsplit(as.character(main_202306$oa_status_2023_may),',\\s*'), function(x) toString(sort(x)))

oa_status_change_202306 <- main_202306 %>% 
  select(title, source_title, year, oa_status_2023_may, oa_status_2023_june, DOI) %>%
  filter(main_202306$oa_status_2023_may != main_202306$oa_status_2023_june) %>% 
  arrange(source_title) 

open2close_202306 <- oa_status_change_202306 %>% 
  filter(oa_status_2023_june == "Closed") %>% 
  write_csv("data_intermediate/open2close_202306.csv")

close2open_202306 <- oa_status_change_202306 %>% 
  filter(oa_status_2023_may == "Closed")

# close2green_10 <- oa_status_change_10 %>% 
#   filter(oa_status_september == "Closed" & oa_status_october == "All Open Access, Green") %>% 
#   write_csv("data_intermediate/close2green_10.csv")


close2green_202306 <- oa_status_change_202306 %>% 
  filter(oa_status_2023_may == "Closed" & str_detect(oa_status_2023_june, "Green")) %>% 
  write_csv("data_intermediate/close2green_202306.csv")

  
green_added_202306 <- oa_status_change_202306 %>% 
  filter(!str_detect(oa_status_2023_may, "Green") & str_detect(oa_status_2023_june, "Green"))

green_removed_202306 <- oa_status_change_202306 %>% 
  filter(str_detect(oa_status_2023_may, "Green") & !str_detect(oa_status_2023_june, "Green"))

## OA status changes comparing with March 2022

oa_comp_202203_202306 <- inner_join(scopus_2022_march, scopus_2023_june, by = "DOI")
oa_comp_202203_202306 <- oa_comp_202203_202306[-c(11:14, 16, 17, 19)]
names(oa_comp_202203_202306)[c(1:12)] <- c("author", "title", "year", "source_title", "citations_2022_march", "DOI", "doc_type", "pub_stage", "oa_status_2022_march", "EID", "citations_2023_june", "oa_status_2023_june")


# Modify "OA Status" to match the changes by Scopus 
oa_comp_202203_202306 <- oa_comp_202203_202306 %>% 
  mutate(oa_status_2023_june = str_replace(oa_status_2023_june, "Hybrid Gold Open Access","Hybrid Gold")) %>%
  mutate(oa_status_2023_june = str_replace(oa_status_2023_june, "Gold Open Access","Gold")) %>% 
  mutate(oa_status_2023_june = str_replace(oa_status_2023_june, "Green Open Access","Green")) %>%
  mutate(oa_status_2023_june = str_replace(oa_status_2023_june, "Bronze Open Access","Bronze")) %>% 
  mutate(oa_status_2023_june = str_replace(oa_status_2023_june, ";",",")) %>% 
  mutate(oa_status_2023_june = str_replace(oa_status_2023_june, ";",",")) 

# df$Modules <- sapply(strsplit(as.character(df$Modules), ',\\s*'), function(x) toString(sort(x)))

oa_comp_202203_202306$oa_status_2022_march <- sapply(strsplit(as.character(oa_comp_202203_202306$oa_status_2022_march),',\\s*'), function(x) toString(sort(x)))


oa_status_change_202203_202306 <- oa_comp_202203_202306 %>% 
  select(title, source_title, year, oa_status_2022_march, oa_status_2023_june, DOI) %>%
  filter(oa_comp_202203_202306$oa_status_2022_march != oa_comp_202203_202306$oa_status_2023_june) %>% 
  arrange(source_title)

open2close_202203_202306 <- oa_status_change_202203_202306 %>% 
  filter(oa_status_2023_june == "Closed") %>% 
  write_csv("data_intermediate/open2close_202203_202306.csv")

close2open_202203_202306 <- oa_status_change_202203_202306 %>% 
  filter(oa_status_2022_march == "Closed")


close2green_202203_202306 <- oa_status_change_202203_202306 %>% 
  filter(oa_status_2022_march == "Closed" & str_detect(oa_status_2023_june, "Green")) %>% 
  write_csv("data_intermediate/close2green_202203_202306.csv")

  
green_added_202203_202306 <- oa_status_change_202203_202306 %>% 
  filter(!str_detect(oa_status_2022_march, "Green") & str_detect(oa_status_2023_june, "Green"))

green_removed_202203_202306 <- oa_status_change_202203_202306 %>% 
  filter(str_detect(oa_status_2022_march, "Green") & !str_detect(oa_status_2023_june, "Green"))

gold_added_202203_202306_1 <- oa_status_change_202203_202306 %>% 
  filter(!str_detect(oa_status_2022_march, ("Gold")) & str_detect(oa_status_2023_june, "Gold")) %>% 
  write_csv("data_intermediate/gold_added_202203_202306_1.csv")

gold_added_202203_202306_2 <- oa_status_change_202203_202306 %>% 
  filter(str_detect(oa_status_2022_march, ("Hybrid Gold")) & str_detect(oa_status_2023_june, "Gold")) %>% 
  write_csv("data_intermediate/gold_added_202203_202306_2.csv")

length(unique(oa_comp_202203_202306$source_title))

h_gold_added_202203_202306 <- oa_status_change_202203_202306 %>% 
  filter(!str_detect(oa_status_2022_march, ("Gold")) & str_detect(oa_status_2023_june, "Hybrid Gold"))

# See report of May 2023 - 13 articles previously published as closed or green, later turned to be hybrid gold. it can be errors in data.

```

Publications by Year & by OA Status (Data Retrieved on June 2nd, 2023)

```{r, 2023-June-OA-status}

# OA status in 2023 June
main_202306 %>% 
  separate(oa_status_2023_june, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(year) %>% 
  count(is_oa, oa_status) %>% 
  mutate(percent = 100*n/sum(n)) %>% 
  ungroup() %>% 
  qhpvt(
    c("is_oa","oa_status"), 
    "year", 
    c("Count" = "sum(n)", "%" = "sum(percent)"),
    formats = list("%.0f", "%.2f"),
    totals = list("is_oa" = "Total", "oa_status" = "Total"),
    totalStyle = list("font-weight"="bold")
    )
```
* Citations
  * Comparing with 2023 May, **2,649 items** obtained more citations, while **31 items** saw a decrease in citation counts.
  * Citations per paper(CpP) for OA publications was **37.47** while for closed publications was **around 13.91**. 

```{r, 2023-June-citations}


# Citations in 2023 June
citations_change_202306 <- main_202306 %>% 
  select(title, source_title, year, citations_2023_may, citations_2023_june) %>% 
  filter(citations_2023_june - citations_2023_may != 0) %>% 
  mutate(citations_diff = citations_2023_june - citations_2023_may, 
         citations_percentage = ifelse(
           citations_2023_may != 0, (citations_2023_june - citations_2023_may)*100 / citations_2023_may, ifelse(citations_2023_may == 0, NA, 999))) %>% 
  arrange(desc(citations_diff), desc(citations_percentage))

citations_error_202306 <- citations_change_202306 %>% 
  select(title, source_title, year, citations_2023_may, citations_2023_june, citations_diff) %>%
  filter(citations_diff < 0)

citations_per_paper_202306 <- main_202306 %>%
  separate(oa_status_2023_june, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(is_oa) %>% 
  mutate(CpP_202306 = sum(citations_2023_june)/n())

```
Citations by Year & by OA Status (Data Retrieved on June 2nd, 2023)

```{r, 2023-June-citations-per-paper}


# Citations per Paper in 2023 June
main_202306 %>% 
  separate(oa_status_2023_june, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(year, oa_status) %>% 
  mutate(citations_per_paper = round(sum(citations_2023_june)/n())) %>%   # added a new column the citations per paper
  select(year, is_oa, oa_status, citations_2023_june, citations_per_paper) %>%  
  ungroup() %>%  
  qhpvt(
    c("is_oa", "oa_status"), 
    "year", 
    c("Count" = "n()", "CpP" = "sum(citations_per_paper)/n()"),
    formats = list("%.0f", "%.0f"),
    totals = list("oa_status" = "Total", "Year" = "Total"),
    totalStyle = list("font-weight"="bold")
    )
```

## 2023 May
Data was retrieved from Scopus on May 1st, 2023. 


```{r, 2023-May-data-preparation}

# read May data
scopus_2023_may <- read_csv("data/scopus_20230501.csv")


# select only columns relevant
scopus_2023_may <- scopus_2023_may[c(1,3,4,5,12,13,15:17,19)]

# rename columns
names(scopus_2023_may)[c(1:10)] <- c("author", "title", "year", "source_title", "citations_2023_may", "DOI", "doc_type", "pub_stage", "oa_status_2023_may", "EID")


# Replace NAs in citations and OA status, remove rows with missing or duplicated DOIs
scopus_2023_may <- scopus_2023_may %>% 
  replace_na(list(oa_status_2023_may = "Closed", citations_2023_may = 0)) %>% 
  filter(!is.na(DOI)) %>% 
  filter(!DOI %in% DOI[duplicated(DOI)]) %>% 
  write_csv("data_intermediate/scopus_2023_may.csv")

# read April data
scopus_2023_april <- read_csv("data_intermediate/scopus_2023_april.csv")


# records removed from 2022 March
removed_202305 <- anti_join(scopus_2022_march, scopus_2023_may, by = "DOI") 
removed_202305 <- removed_202305 %>%
  select(source_title, year, pub_stage, oa_status_2022_march, DOI) %>% 
  arrange(source_title) %>% 
  write_csv("data_intermediate/removed_202305.csv")

# new records in 2023 May
added_202305 <- anti_join(scopus_2023_may, scopus_2022_march, by = "DOI") 

added_202305 <- added_202305 %>% 
  select(source_title, year, pub_stage, oa_status_2023_may, DOI) %>%
  arrange(source_title)

# shared items of 2023 April and 2023 May
main_202305 <- inner_join(scopus_2023_april, scopus_2023_may, by = "DOI")
main_202305 <- main_202305[-c(11:14, 16, 17, 19)]

names(main_202305)[c(1:12)] <- c("author", "title", "year", "source_title", "citations_2023_april", "DOI", "doc_type", "pub_stage", "oa_status_2023_april", "EID", "citations_2023_may", "oa_status_2023_may")
```
* Number of records (Comparing with 2022 March)
  After removing records with missing DOIs or duplicated DOIs, **9,927 records** were kept. **65 items** were removed from the data set of March 2022 and **173 items** were added. The total data change was **around 2.4%**.
  
* OA Status (Comparing with 2023 April)
  * Comparing with 2023 April, the OA status of **3 items** changed. None OA items turned to be closed and none closed items became open access. 
  * **One item turned green where none of them were closed items in April**. None items lost their green status.

```{r, 2023-May-findings}

#---- Findings - OA Status ----

oa_status_change_202305 <- main_202305 %>% 
  select(title, source_title, year, oa_status_2023_april, oa_status_2023_may, DOI) %>%
  filter(main_202305$oa_status_2023_april != main_202305$oa_status_2023_may) %>% 
  arrange(source_title) 

open2close_202305 <- oa_status_change_202305 %>% 
  filter(oa_status_2023_may == "Closed") %>% 
  write_csv("data_intermediate/open2close_202305.csv")

close2open_202305 <- oa_status_change_202305 %>% 
  filter(oa_status_2023_april == "Closed")

# close2green_10 <- oa_status_change_10 %>% 
#   filter(oa_status_september == "Closed" & oa_status_october == "All Open Access, Green") %>% 
#   write_csv("data_intermediate/close2green_10.csv")


close2green_202305 <- oa_status_change_202305 %>% 
  filter(oa_status_2023_april == "Closed" & str_detect(oa_status_2023_may, "Green")) %>% 
  write_csv("data_intermediate/close2green_202305.csv")

  
green_added_202305 <- oa_status_change_202305 %>% 
  filter(!str_detect(oa_status_2023_april, "Green") & str_detect(oa_status_2023_may, "Green"))

green_removed_202305 <- oa_status_change_202305 %>% 
  filter(str_detect(oa_status_2023_april, "Green") & !str_detect(oa_status_2023_may, "Green"))

## OA status changes comparing with March 2022

oa_comp_202203_202305 <- inner_join(scopus_2022_march, scopus_2023_may, by = "DOI")
oa_comp_202203_202305 <- oa_comp_202203_202305[-c(11:14, 16, 17, 19)]
names(oa_comp_202203_202305)[c(1:12)] <- c("author", "title", "year", "source_title", "citations_2022_march", "DOI", "doc_type", "pub_stage", "oa_status_2022_march", "EID", "citations_2023_may", "oa_status_2023_may")

oa_status_change_202203_202305 <- oa_comp_202203_202305 %>% 
  select(title, source_title, year, oa_status_2022_march, oa_status_2023_may, DOI) %>%
  filter(oa_comp_202203_202305$oa_status_2022_march != oa_comp_202203_202305$oa_status_2023_may) %>% 
  arrange(source_title)

open2close_202203_202305 <- oa_status_change_202203_202305 %>% 
  filter(oa_status_2023_may == "Closed") %>% 
  write_csv("data_intermediate/open2close_202203_202305.csv")

close2open_202203_202305 <- oa_status_change_202203_202305 %>% 
  filter(oa_status_2022_march == "Closed")


close2green_202203_202305 <- oa_status_change_202203_202305 %>% 
  filter(oa_status_2022_march == "Closed" & str_detect(oa_status_2023_may, "Green")) %>% 
  write_csv("data_intermediate/close2green_202203_202305.csv")

  
green_added_202203_202305 <- oa_status_change_202203_202305 %>% 
  filter(!str_detect(oa_status_2022_march, "Green") & str_detect(oa_status_2023_may, "Green"))

green_removed_202203_202305 <- oa_status_change_202203_202305 %>% 
  filter(str_detect(oa_status_2022_march, "Green") & !str_detect(oa_status_2023_may, "Green"))

gold_added_202203_202305_1 <- oa_status_change_202203_202305 %>% 
  filter(!str_detect(oa_status_2022_march, ("Gold")) & str_detect(oa_status_2023_may, "Gold")) %>% 
  write_csv("data_intermediate/gold_added_202203_202305_1.csv")

gold_added_202203_202305_2 <- oa_status_change_202203_202305 %>% 
  filter(str_detect(oa_status_2022_march, ("Hybrid Gold")) & str_detect(oa_status_2023_may, "Gold")) %>% 
  write_csv("data_intermediate/gold_added_202203_202305_2.csv")

length(unique(oa_comp_202203_202305$source_title))

h_gold_added_202203_202305 <- oa_status_change_202203_202305 %>% 
  filter(!str_detect(oa_status_2022_march, ("Gold")) & str_detect(oa_status_2023_may, "Hybrid Gold"))

# 13 articles previously published as closed or green, later turned to be hybrid gold. it can be errors in data.

```

Publications by Year & by OA Status (Data Retrieved on May 1st, 2023)

```{r, 2023-May-OA-status}

# OA status in 2023 May
main_202305 %>% 
  separate(oa_status_2023_may, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(year) %>% 
  count(is_oa, oa_status) %>% 
  mutate(percent = 100*n/sum(n)) %>% 
  ungroup() %>% 
  qhpvt(
    c("is_oa","oa_status"), 
    "year", 
    c("Count" = "sum(n)", "%" = "sum(percent)"),
    formats = list("%.0f", "%.2f"),
    totals = list("is_oa" = "Total", "oa_status" = "Total"),
    totalStyle = list("font-weight"="bold")
    )
```
* Citations
  * Comparing with 2023 April, **2,170 items** obtained more citations, while 3 items saw a decrease in citation counts.
  * Citations per paper(CpP) for OA publications was **37.36** while for closed publications was **around 13.76**. 

```{r, 2023-May-citations}


# Citations in 2023 May
citations_change_202305 <- main_202305 %>% 
  select(title, source_title, year, citations_2023_april, citations_2023_may) %>% 
  filter(citations_2023_may - citations_2023_april != 0) %>% 
  mutate(citations_diff = citations_2023_may - citations_2023_april, 
         citations_percentage = ifelse(
           citations_2023_april != 0, (citations_2023_may - citations_2023_april)*100 / citations_2023_april, ifelse(citations_2023_april == 0, NA, 999))) %>% 
  arrange(desc(citations_diff), desc(citations_percentage))

citations_error_202305 <- citations_change_202305 %>% 
  select(title, source_title, year, citations_2023_april, citations_2023_may, citations_diff) %>%
  filter(citations_diff < 0)

citations_per_paper_202305 <- main_202305 %>%
  separate(oa_status_2023_may, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(is_oa) %>% 
  mutate(CpP_202305 = sum(citations_2023_may)/n())

```
Citations by Year & by OA Status (Data Retrieved on May 1st, 2023)

```{r, 2023-May-citations-per-paper}


# Citations per Paper in 2023 May
main_202305 %>% 
  separate(oa_status_2023_may, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(year, oa_status) %>% 
  mutate(citations_per_paper = round(sum(citations_2023_may)/n())) %>%   # added a new column the citations per paper
  select(year, is_oa, oa_status, citations_2023_may, citations_per_paper) %>%  
  ungroup() %>%  
  qhpvt(
    c("is_oa", "oa_status"), 
    "year", 
    c("Count" = "n()", "CpP" = "sum(citations_per_paper)/n()"),
    formats = list("%.0f", "%.0f"),
    totals = list("oa_status" = "Total", "Year" = "Total"),
    totalStyle = list("font-weight"="bold")
    )
```


## 2023 April
Data was retrieved from Scopus on April 3rd, 2023. 


```{r, 2023-April-data-preparation}

# read April data
scopus_2023_april <- read_csv("data/scopus_20230403.csv")


# select only columns relevant
scopus_2023_april <- scopus_2023_april[c(1,3,4,5,12,13,15:17,19)]

# rename columns
names(scopus_2023_april)[c(1:10)] <- c("author", "title", "year", "source_title", "citations_2023_april", "DOI", "doc_type", "pub_stage", "oa_status_2023_april", "EID")


# Replace NAs in citations and OA status, remove rows with missing or duplicated DOIs
scopus_2023_april <- scopus_2023_april %>% 
  replace_na(list(oa_status_2023_april = "Closed", citations_2023_april = 0)) %>% 
  filter(!is.na(DOI)) %>% 
  filter(!DOI %in% DOI[duplicated(DOI)]) %>% 
  write_csv("data_intermediate/scopus_2023_april.csv")

# read March data
scopus_2023_march <- read_csv("data_intermediate/scopus_2023_march.csv")


# records removed from 2022 March
removed_202304 <- anti_join(scopus_2022_march, scopus_2023_april, by = "DOI") 
removed_202304 <- removed_202304 %>%
  select(source_title, year, pub_stage, oa_status_2022_march, DOI) %>% 
  arrange(source_title) %>% 
  write_csv("data_intermediate/removed_202304.csv")

# new records in 2023 April
added_202304 <- anti_join(scopus_2023_april, scopus_2022_march, by = "DOI") 

added_202304 <- added_202304 %>% 
  select(source_title, year, pub_stage, oa_status_2023_april, DOI) %>%
  arrange(source_title)

# shared items of 2023 March and 2023 April
main_202304 <- inner_join(scopus_2023_march, scopus_2023_april, by = "DOI")
main_202304 <- main_202304[-c(11:14, 16, 17, 19)]

names(main_202304)[c(1:12)] <- c("author", "title", "year", "source_title", "citations_2023_march", "DOI", "doc_type", "pub_stage", "oa_status_2023_march", "EID", "citations_2023_april", "oa_status_2023_april")
```
* Number of records (Comparing with 2022 March)
  After removing records with missing DOIs or duplicated DOIs, **9,924 records** were kept. **64 items** were removed from the data set of March 2022 and **169 items** were added. The total data change was **around 2.4%**.
  
* OA Status (Comparing with 2023 March)
  * Comparing with 2023 March, the OA status of **83 items** changed. 19 OA items turned to be closed; while 13 items became open access. 
  * **45 items turned green where 13 of them were closed items in March**. 33 items lost their green status.

```{r, 2023-April-findings}

#---- Findings - OA Status ----

oa_status_change_202304 <- main_202304 %>% 
  select(title, source_title, year, oa_status_2023_march, oa_status_2023_april, DOI) %>%
  filter(main_202304$oa_status_2023_march != main_202304$oa_status_2023_april) %>% 
  arrange(source_title) 

open2close_202304 <- oa_status_change_202304 %>% 
  filter(oa_status_2023_april == "Closed") %>% 
  write_csv("data_intermediate/open2close_202304.csv")

close2open_202304 <- oa_status_change_202304 %>% 
  filter(oa_status_2023_march == "Closed")

# close2green_10 <- oa_status_change_10 %>% 
#   filter(oa_status_september == "Closed" & oa_status_october == "All Open Access, Green") %>% 
#   write_csv("data_intermediate/close2green_10.csv")


close2green_202304 <- oa_status_change_202304 %>% 
  filter(oa_status_2023_march == "Closed" & str_detect(oa_status_2023_april, "Green")) %>% 
  write_csv("data_intermediate/close2green_202304.csv")

  
green_added_202304 <- oa_status_change_202304 %>% 
  filter(!str_detect(oa_status_2023_march, "Green") & str_detect(oa_status_2023_april, "Green"))

green_removed_202304 <- oa_status_change_202304 %>% 
  filter(str_detect(oa_status_2023_march, "Green") & !str_detect(oa_status_2023_april, "Green"))
```

Publications by Year & by OA Status (Data Retrieved on April 3rd, 2023)

```{r, 2023-April-OA-status}

# OA status in 2023 April
main_202304 %>% 
  separate(oa_status_2023_april, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(year) %>% 
  count(is_oa, oa_status) %>% 
  mutate(percent = 100*n/sum(n)) %>% 
  ungroup() %>% 
  qhpvt(
    c("is_oa","oa_status"), 
    "year", 
    c("Count" = "sum(n)", "%" = "sum(percent)"),
    formats = list("%.0f", "%.2f"),
    totals = list("is_oa" = "Total", "oa_status" = "Total"),
    totalStyle = list("font-weight"="bold")
    )
```
* Citations
  * Comparing with 2023 March, **2,521 items** obtained more citations, while 3 items saw a decrease in citation counts.
  * Citations per paper(CpP) for OA publications was **36.82** while for closed publications was **around 13.52**. 

```{r, 2023-April-citations}


# Citations in 2023 April
citations_change_202304 <- main_202304 %>% 
  select(title, source_title, year, citations_2023_march, citations_2023_april) %>% 
  filter(citations_2023_april - citations_2023_march != 0) %>% 
  mutate(citations_diff = citations_2023_april - citations_2023_march, 
         citations_percentage = ifelse(
           citations_2023_march != 0, (citations_2023_april - citations_2023_march)*100 / citations_2023_march, ifelse(citations_2023_march == 0, NA, 999))) %>% 
  arrange(desc(citations_diff), desc(citations_percentage))

citations_error_202304 <- citations_change_202304 %>% 
  select(title, source_title, year, citations_2023_march, citations_2023_april, citations_diff) %>%
  filter(citations_diff < 0)

citations_per_paper_202304 <- main_202304 %>%
  separate(oa_status_2023_april, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(is_oa) %>% 
  mutate(CpP_202304 = sum(citations_2023_april)/n())

```
Citations by Year & by OA Status (Data Retrieved on April 3rd, 2023)

```{r, 2023-April-citations-per-paper}


# Citations per Paper in 2023 April
main_202304 %>% 
  separate(oa_status_2023_april, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(year, oa_status) %>% 
  mutate(citations_per_paper = round(sum(citations_2023_april)/n())) %>%   # added a new column the citations per paper
  select(year, is_oa, oa_status, citations_2023_april, citations_per_paper) %>%  
  ungroup() %>%  
  qhpvt(
    c("is_oa", "oa_status"), 
    "year", 
    c("Count" = "n()", "CpP" = "sum(citations_per_paper)/n()"),
    formats = list("%.0f", "%.0f"),
    totals = list("oa_status" = "Total", "Year" = "Total"),
    totalStyle = list("font-weight"="bold")
    )
```


## 2023 March
Data was retrieved from Scopus on March 1st, 2023. 


```{r, 2023-March-data-preparation}

# read March data
scopus_2023_march <- read_csv("data/scopus_20230301.csv")


# select only columns relevant
scopus_2023_march <- scopus_2023_march[c(1,3,4,5,12,13,15:17,19)]

# rename columns
names(scopus_2023_march)[c(1:10)] <- c("author", "title", "year", "source_title", "citations_2023_march", "DOI", "doc_type", "pub_stage", "oa_status_2023_march", "EID")


# Replace NAs in citations and OA status, remove rows with missing or duplicated DOIs
scopus_2023_march <- scopus_2023_march %>% 
  replace_na(list(oa_status_2023_march = "Closed", citations_2023_march = 0)) %>% 
  filter(!is.na(DOI)) %>% 
  filter(!DOI %in% DOI[duplicated(DOI)]) %>% 
  write_csv("data_intermediate/scopus_2023_march.csv")

# read February data
scopus_2023_february <- read_csv("data_intermediate/scopus_2023_february.csv")


# records removed from 2022 March
removed_202303 <- anti_join(scopus_2022_march, scopus_2023_march, by = "DOI") 
removed_202303 <- removed_202303%>%
  select(source_title, year, pub_stage, oa_status_2022_march, DOI) %>% 
  arrange(source_title) %>% 
  write_csv("data_intermediate/removed_202303.csv")

# new records in 2023 March
added_202303 <- anti_join(scopus_2023_march, scopus_2022_march, by = "DOI") 

added_202303 <- added_202303 %>% 
  select(source_title, year, pub_stage, oa_status_2023_march, DOI) %>%
  arrange(source_title)

# shared items of 2023 February and 2023 March
main_202303 <- inner_join(scopus_2023_february, scopus_2023_march, by = "DOI")
main_202303 <- main_202303[-c(11:14, 16, 17, 19)]

names(main_202303)[c(1:12)] <- c("author", "title", "year", "source_title", "citations_2023_february", "DOI", "doc_type", "pub_stage", "oa_status_2023_february", "EID", "citations_2023_march", "oa_status_2023_march")
```
* Number of records (Comparing with 2022 March)
  After removing records with missing DOIs or duplicated DOIs, **9,896 records** were kept. **63 items** were removed from the data set of March 2022 and **140 items** were added. The total data change was **around 2.1%**.
  
* OA Status (Comparing with 2023 February)
  * Comparing with 2023 February, the OA status of **134 items** changed. 35 OA items turned to be closed; while 12 items became open access. 
  * **16 items turned green where 7 of them were closed items in February**. 64 items lost their green status.

```{r, 2023-March-findings}

#---- Findings - OA Status ----

oa_status_change_202303 <- main_202303 %>% 
  select(title, source_title, year, oa_status_2023_february, oa_status_2023_march, DOI) %>%
  filter(main_202303$oa_status_2023_february != main_202303$oa_status_2023_march) %>% 
  arrange(source_title) 

open2close_202303 <- oa_status_change_202303 %>% 
  filter(oa_status_2023_march == "Closed") %>% 
  write_csv("data_intermediate/open2close_202303.csv")

close2open_202303 <- oa_status_change_202303 %>% 
  filter(oa_status_2023_february == "Closed")

# close2green_10 <- oa_status_change_10 %>% 
#   filter(oa_status_september == "Closed" & oa_status_october == "All Open Access, Green") %>% 
#   write_csv("data_intermediate/close2green_10.csv")


close2green_202303 <- oa_status_change_202303 %>% 
  filter(oa_status_2023_february == "Closed" & str_detect(oa_status_2023_march, "Green")) %>% 
  write_csv("data_intermediate/close2green_202303.csv")

  
green_added_202303 <- oa_status_change_202303 %>% 
  filter(!str_detect(oa_status_2023_february, "Green") & str_detect(oa_status_2023_march, "Green"))

green_removed_202303 <- oa_status_change_202303 %>% 
  filter(str_detect(oa_status_2023_february, "Green") & !str_detect(oa_status_2023_march, "Green"))
```

Publications by Year & by OA Status (Data Retrieved on March 1st, 2023)
```{r, 2023-March-OA-status}

# OA status in 2023 March
main_202303 %>% 
  separate(oa_status_2023_march, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(year) %>% 
  count(is_oa, oa_status) %>% 
  mutate(percent = 100*n/sum(n)) %>% 
  ungroup() %>% 
  qhpvt(
    c("is_oa","oa_status"), 
    "year", 
    c("Count" = "sum(n)", "%" = "sum(percent)"),
    formats = list("%.0f", "%.2f"),
    totals = list("is_oa" = "Total", "oa_status" = "Total"),
    totalStyle = list("font-weight"="bold")
    )
```
* Citations
  * Comparing with 2023 Feburary, **2,275 items** obtained more citations, while 4 items saw a decrease in citation counts.
  * Citations per paper(CpP) for OA publications was **36.02** while for closed publications was **around 13.16**. 

```{r, 2023-March-citations}


# Citations in 2023 March
citations_change_202303 <- main_202303 %>% 
  select(title, source_title, year, citations_2023_february, citations_2023_march) %>% 
  filter(citations_2023_march - citations_2023_february != 0) %>% 
  mutate(citations_diff = citations_2023_march - citations_2023_february, 
         citations_percentage = ifelse(
           citations_2023_february != 0, (citations_2023_march - citations_2023_february)*100 / citations_2023_february, ifelse(citations_2023_february == 0, NA, 999))) %>% 
  arrange(desc(citations_diff), desc(citations_percentage))

citations_error_202303 <- citations_change_202303 %>% 
  select(title, source_title, year, citations_2023_february, citations_2023_march, citations_diff) %>%
  filter(citations_diff < 0)

citations_per_paper_202303 <- main_202303 %>%
  separate(oa_status_2023_march, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(is_oa) %>% 
  mutate(CpP_202303 = sum(citations_2023_march)/n())

```
Citations by Year & by OA Status (Data Retrieved on March 1st, 2023)

```{r, 2023-March-citations-per-paper}


# Citations per Paper in 2023 March
main_202303 %>% 
  separate(oa_status_2023_march, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(year, oa_status) %>% 
  mutate(citations_per_paper = round(sum(citations_2023_march)/n())) %>%   # added a new column the citations per paper
  select(year, is_oa, oa_status, citations_2023_march, citations_per_paper) %>%  
  ungroup() %>%  
  qhpvt(
    c("is_oa", "oa_status"), 
    "year", 
    c("Count" = "n()", "CpP" = "sum(citations_per_paper)/n()"),
    formats = list("%.0f", "%.0f"),
    totals = list("oa_status" = "Total", "Year" = "Total"),
    totalStyle = list("font-weight"="bold")
    )
```



## 2023 February
Data was retrieved from Scopus on February 1st, 2023. 


```{r, 2023-February-data-preparation}

# read February data
scopus_2023_february <- read_csv("data/scopus_20230201.csv")


# select only columns relevant
scopus_2023_february <- scopus_2023_february[c(1,3,4,5,12,13,15:17,19)]

# rename columns
names(scopus_2023_february)[c(1:10)] <- c("author", "title", "year", "source_title", "citations_2023_february", "DOI", "doc_type", "pub_stage", "oa_status_2023_february", "EID")


# Replace NAs in citations and OA status, remove rows with missing or duplicated DOIs
scopus_2023_february <- scopus_2023_february %>% 
  replace_na(list(oa_status_2023_february = "Closed", citations_2023_february = 0)) %>% 
  filter(!is.na(DOI)) %>% 
  filter(!DOI %in% DOI[duplicated(DOI)]) %>% 
  write_csv("data_intermediate/scopus_2023_february.csv")

# read January data
scopus_2023_january <- read_csv("data_intermediate/scopus_2023_january.csv")


# records removed from 2022 March
removed_202302 <- anti_join(scopus_2022_march, scopus_2023_february, by = "DOI") 
removed_202302 <- removed_202302%>%
  select(source_title, year, pub_stage, oa_status_2022_march, DOI) %>% 
  arrange(source_title) %>% 
  write_csv("data_intermediate/removed_202302.csv")

# new records in 2023 February
added_202302 <- anti_join(scopus_2023_february, scopus_2022_march, by = "DOI") 

added_202302 <- added_202302 %>% 
  select(source_title, year, pub_stage, oa_status_2023_february, DOI) %>%
  arrange(source_title)

# shared items of 2023 January and 2023 February
main_202302 <- inner_join(scopus_2023_january, scopus_2023_february, by = "DOI")
main_202302 <- main_202302[-c(11:14, 16, 17, 19)]

names(main_202302)[c(1:12)] <- c("author", "title", "year", "source_title", "citations_2023_january", "DOI", "doc_type", "pub_stage", "oa_status_2023_january", "EID", "citations_2023_february", "oa_status_2023_february")
```
* Number of records (Comparing with 2022 March)
  After removing records with missing DOIs or duplicated DOIs, **9,888 records** were kept. **60 items** were removed from the data set of March and **134 items** were added. The total data change was **around 2.0%**.
  
* OA Status (Comparing with 2023 January)
  * Comparing with 2023 January, the OA status of **79 items** changed. 14 OA items turned to be closed; while 24 items became open access. 
  * **12 items turned green where 4 of them were closed items in January**. 5 items lost their green status.

```{r, 2023-February-findings}

#---- Findings - OA Status ----

oa_status_change_202302 <- main_202302 %>% 
  select(title, source_title, year, oa_status_2023_january, oa_status_2023_february, DOI) %>%
  filter(main_202302$oa_status_2023_january != main_202302$oa_status_2023_february) %>% 
  arrange(source_title) 

open2close_202302 <- oa_status_change_202302 %>% 
  filter(oa_status_2023_february == "Closed") %>% 
  write_csv("data_intermediate/open2close_202302.csv")

close2open_202302 <- oa_status_change_202302 %>% 
  filter(oa_status_2023_january == "Closed")

# close2green_10 <- oa_status_change_10 %>% 
#   filter(oa_status_september == "Closed" & oa_status_october == "All Open Access, Green") %>% 
#   write_csv("data_intermediate/close2green_10.csv")


close2green_202302 <- oa_status_change_202302 %>% 
  filter(oa_status_2023_january == "Closed" & str_detect(oa_status_2023_february, "Green")) %>% 
  write_csv("data_intermediate/close2green_202302.csv")

  
green_added_202302 <- oa_status_change_202302 %>% 
  filter(!str_detect(oa_status_2023_january, "Green") & str_detect(oa_status_2023_february, "Green"))

green_removed_202302 <- oa_status_change_202302 %>% 
  filter(str_detect(oa_status_2023_january, "Green") & !str_detect(oa_status_2023_february, "Green"))
```

Publications by Year & by OA Status (Data Retrieved on February 1st, 2023)
```{r, 2023-February-OA-status}

# OA status in 2023 February
main_202302 %>% 
  separate(oa_status_2023_february, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(year) %>% 
  count(is_oa, oa_status) %>% 
  mutate(percent = 100*n/sum(n)) %>% 
  ungroup() %>% 
  qhpvt(
    c("is_oa","oa_status"), 
    "year", 
    c("Count" = "sum(n)", "%" = "sum(percent)"),
    formats = list("%.0f", "%.2f"),
    totals = list("is_oa" = "Total", "oa_status" = "Total"),
    totalStyle = list("font-weight"="bold")
    )
```
* Citations
  * Comparing with 2023 January, **2,030 items** obtained more citations.
  * Citations per paper(CpP) for OA publications was **35.29** while for closed publications was **around 12.83**. 

```{r, 2023-February-citations}


# Citations in 2023 February
citations_change_202302 <- main_202302 %>% 
  select(title, source_title, year, citations_2023_january, citations_2023_february) %>% 
  filter(citations_2023_february - citations_2023_january != 0) %>% 
  mutate(citations_diff = citations_2023_february - citations_2023_january, 
         citations_percentage = ifelse(
           citations_2023_january != 0, (citations_2023_february - citations_2023_january)*100 / citations_2023_january, ifelse(citations_2023_january == 0, NA, 999))) %>% 
  arrange(desc(citations_diff), desc(citations_percentage))

citations_error_202302 <- citations_change_202302 %>% 
  select(title, source_title, year, citations_2023_january, citations_2023_february, citations_diff) %>%
  filter(citations_diff < 0)

citations_per_paper_202302 <- main_202302 %>%
  separate(oa_status_2023_february, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(is_oa) %>% 
  mutate(CpP_202302 = sum(citations_2023_february)/n())

```
Citations by Year & by OA Status (Data Retrieved on February 1st, 2023)

```{r, 2023-February-citations-per-paper}


# Citations per Paper in 2023 February
main_202302 %>% 
  separate(oa_status_2023_february, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(year, oa_status) %>% 
  mutate(citations_per_paper = round(sum(citations_2023_february)/n())) %>%   # added a new column the citations per paper
  select(year, is_oa, oa_status, citations_2023_february, citations_per_paper) %>%  
  ungroup() %>%  
  qhpvt(
    c("is_oa", "oa_status"), 
    "year", 
    c("Count" = "n()", "CpP" = "sum(citations_per_paper)/n()"),
    formats = list("%.0f", "%.0f"),
    totals = list("oa_status" = "Total", "Year" = "Total"),
    totalStyle = list("font-weight"="bold")
    )
```


## 2023 January
Data was retrieved from Scopus on January 2nd, 2023. 


```{r, 2023-January-data-preparation}

# read January data
scopus_2023_january <- read_csv("data/scopus_20230102.csv")


# select only columns relevant
scopus_2023_january <- scopus_2023_january[c(1,3,4,5,12,13,15:17,19)]

# rename columns
names(scopus_2023_january)[c(1:10)] <- c("author", "title", "year", "source_title", "citations_2023_january", "DOI", "doc_type", "pub_stage", "oa_status_2023_january", "EID")


# Replace NAs in citations and OA status, remove rows with missing or duplicated DOIs
scopus_2023_january <- scopus_2023_january %>% 
  replace_na(list(oa_status_2023_january = "Closed", citations_2023_january = 0)) %>% 
  filter(!is.na(DOI)) %>% 
  filter(!DOI %in% DOI[duplicated(DOI)]) %>% 
  write_csv("data_intermediate/scopus_2023_january.csv")

# read December data
scopus_2022_december <- read_csv("data_intermediate/scopus_december.csv")


# records removed from 2022 March
removed_202301 <- anti_join(scopus_2022_march, scopus_2023_january, by = "DOI") 
removed_202301 <- removed_202301%>%
  select(source_title, year, pub_stage, oa_status_2022_march, DOI) %>% 
  arrange(source_title) %>% 
  write_csv("data_intermediate/removed_202301.csv")

# new records in 2023 January
added_202301 <- anti_join(scopus_2023_january, scopus_2022_march, by = "DOI") 

added_202301 <- added_202301 %>% 
  select(source_title, year, pub_stage, oa_status_2023_january, DOI) %>%
  arrange(source_title)

# shared items of 2022 December and 2023 January
main_202301 <- inner_join(scopus_2022_december, scopus_2023_january, by = "DOI")
main_202301 <- main_202301[-c(11:14, 16, 17, 19)]

names(main_202301)[c(1:12)] <- c("author", "title", "year", "source_title", "citations_2022_december", "DOI", "doc_type", "pub_stage", "oa_status_2022_december", "EID", "citations_2023_january", "oa_status_2023_january")
```
* Number of records (Comparing with 2022 March)
  After removing records with missing DOIs or duplicated DOIs, **9,888 records** were kept. **60 items** were removed from the data set of March and **129 items** were added. The total data change was **around 1.9%**.
  
* OA Status (Comparing with 2022 December)
  * Comparing with 2022 December, the OA status of **92 items** changed. 26 OA items turned to be closed; while 18 items became open access. 
  * **11 items turned green where 9 of them were closed items in December 2022**. 9 items lost their green status.

```{r, 2023-January-findings}

#---- Findings - OA Status ----

oa_status_change_202301 <- main_202301 %>% 
  select(title, source_title, year, oa_status_2022_december, oa_status_2023_january, DOI) %>%
  filter(main_202301$oa_status_2022_december != main_202301$oa_status_2023_january) %>% 
  arrange(source_title) 

open2close_202301 <- oa_status_change_202301 %>% 
  filter(oa_status_2023_january == "Closed") %>% 
  write_csv("data_intermediate/open2close_202301.csv")

close2open_202301 <- oa_status_change_202301 %>% 
  filter(oa_status_2022_december == "Closed")

# close2green_10 <- oa_status_change_10 %>% 
#   filter(oa_status_september == "Closed" & oa_status_october == "All Open Access, Green") %>% 
#   write_csv("data_intermediate/close2green_10.csv")


close2green_202301 <- oa_status_change_202301 %>% 
  filter(oa_status_2022_december == "Closed" & str_detect(oa_status_2023_january, "Green")) %>% 
  write_csv("data_intermediate/close2green_202301.csv")

  
green_added_202301 <- oa_status_change_202301 %>% 
  filter(!str_detect(oa_status_2022_december, "Green") & str_detect(oa_status_2023_january, "Green"))

green_removed_202301 <- oa_status_change_202301 %>% 
  filter(str_detect(oa_status_2022_december, "Green") & !str_detect(oa_status_2023_january, "Green"))
```

Publications by Year & by OA Status (Data Retrieved on January 2nd, 2023)
```{r, 2023-January-OA-status}

# OA status in 2023 January
main_202301 %>% 
  separate(oa_status_2023_january, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(year) %>% 
  count(is_oa, oa_status) %>% 
  mutate(percent = 100*n/sum(n)) %>% 
  ungroup() %>% 
  qhpvt(
    c("is_oa","oa_status"), 
    "year", 
    c("Count" = "sum(n)", "%" = "sum(percent)"),
    formats = list("%.0f", "%.2f"),
    totals = list("is_oa" = "Total", "oa_status" = "Total"),
    totalStyle = list("font-weight"="bold")
    )
```
* Citations
  * Comparing with 2022 December, **2,110 items** obtained more citations.
  * Citations per paper(CpP) for OA publications was **34.81** while for closed publications was **around 12.56**. 

```{r, 2023-January-citations}


# Citations in 2023 January
citations_change_202301 <- main_202301 %>% 
  select(title, source_title, year, citations_2022_december, citations_2023_january) %>% 
  filter(citations_2023_january-citations_2022_december != 0) %>% 
  mutate(citations_diff = citations_2023_january - citations_2022_december, 
         citations_percentage = ifelse(
           citations_2022_december != 0, (citations_2023_january - citations_2022_december)*100 / citations_2022_december, ifelse(citations_2022_december == 0, NA, 999))) %>% 
  arrange(desc(citations_diff), desc(citations_percentage))

citations_error_202301 <- citations_change_202301 %>% 
  select(title, source_title, year, citations_2022_december, citations_2023_january, citations_diff) %>%
  filter(citations_diff < 0)

citations_per_paper_202301 <- main_202301 %>%
  separate(oa_status_2023_january, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(is_oa) %>% 
  mutate(CpP_202301 = sum(citations_2023_january)/n())

```
Citations by Year & by OA Status (Data Retrieved on January 2nd, 2023)

```{r, 2023-January-citations-per-paper}


# Citations per Paper in 2023 January
main_202301 %>% 
  separate(oa_status_2023_january, c("is_oa", "oa_status", "ex_green"), sep = ", ") %>% 
  replace_na(list(oa_status = "Closed")) %>% 
  group_by(year, oa_status) %>% 
  mutate(citations_per_paper = round(sum(citations_2023_january)/n())) %>%   # added a new column the citations per paper
  select(year, is_oa, oa_status, citations_2023_january, citations_per_paper) %>%  
  ungroup() %>%  
  qhpvt(
    c("is_oa", "oa_status"), 
    "year", 
    c("Count" = "n()", "CpP" = "sum(citations_per_paper)/n()"),
    formats = list("%.0f", "%.0f"),
    totals = list("oa_status" = "Total", "Year" = "Total"),
    totalStyle = list("font-weight"="bold")
    )
```


# Web Stats

Comparing Jan and Feb of the four years from 2019 to 2022

## Google Analytics

### March

#### Overview

The page views of the **study spaces page** have **tripled to nearly 10,000 since 2019**. The mobile visits increased from 1,000 to about 5,000 now. **The mobile usage takes almost half of the page views of this page**. 

Comparing with the pandemic time, Jan through March of 2021(blue line), the website visits **increased around 20% in 2022**. The current page views are still **20-30% lower than those before the COVID-19**. 

<br>
![](images/pageview_jan-mar_2019-2022.png)

*Note*

* The page views of library website fluctuate on a weekly basis. The x-axis uses the date of the year 2022. The page views of other year are switched to match the fluctuation and demo the differences by year.
* The second half week of 02/05 in 2022 and the week of 02/19 in 2021, the city was hit by winter storms and the campus was closed.
* The week of 03/12 in 2019 and the week of 03/19 in 2020 & 2022 were spring breaks. 

#### Organic search vs Direct visit
* For the most visited pages like study space, ETD, books, personal librarians, doc del, and accounts, over 65% of visits came from organic searches. 

#### Desktop vs Mobile
* Most pages are still viewed on desktops. 
* Certain pages have obtained more mobile users. The mobile views of the parking and Wi-Fi pages have increased from around 65% to 77% since 2019.
* The use of tablets seems declining.

### Feb
**The overall usage of website increases comparing with the same time period of 2021, but has not come back to the level of 2019 and 2020 (pre-pandemic). **

**Home page clicks - The label [object HTMLDivElement]tab_overlay[object Object] takes over 7% of the clicks but I could not identify the element. Probably this label is for some spots on the search boxes. If true, the search box area got over 60% of the clicks. Need to follow up with this label. **


* Browsers: 65-70% sessions used Chrome; usage of Safari was slightly increased
* Channels: The percentage of sessions which came through organic searches increased from 43% to 60% in 2021 and 58% in 2022. Even before COVID-19, use of organic search was increasing. The pandemic accelerated this trend. 
* Devices: Sessions using desktop have gradually moved to mobile during 2019 through 2021. But 2022 witnessed a jump from 9% to 13% in mobile and a drop from 90% to 84% in desktop. Will follow up to see if it is a new trend. 

```{r, Feb-GA}
# # library(tidyverse)
# # library(pivottabler)
# 
# pageviews <- read_csv("data/pageviews.csv")
# 
# ## pageviews %>% 
# ##   qhpvt("Name", "Year", "sum(Pageviews)")
# 
# 
# pt <- PivotTable$new()
# pt$addData(pageviews)
# pt$addColumnDataGroups("Year")
# pt$addRowDataGroups("Name", 
#                     outlineTotal=list(groupStyleDeclarations=list(color="black")))
# pt$defineCalculation(calculationName = "TotalViews", summariseExpression = "sum(Pageviews)")
# pt$sortRowDataGroups(
#   levelNumber = 1,
#   orderBy = "calculation",
#   sortOrder = "desc",
#   calculationGroupName = "default"
# )
# ## pt$asDataFrame()
# pt$renderPivot()


```

## Google Business Profile

* Profile on Google Reviews
  * Oct - 3 reviews received, all were rated 5 stars. 
  * Sep - 3 reviews received, two were 5-star and one was 4-star. The user pointed out that if you don't pick the right elevator, you may get lost. 
  * Aug - No new reviews.
  * Jul - 1 review received, it was rated 5 stars.
  * Jun - 3 reviews received, all were 5-star ratings.
  * May - No new reviews. 
  * Apr - 2 reviews received, both were 5-star ratings.
  * Mar - 5 reviews received, all were 5-star ratings.
  * Jan and Feb - 4 reviews received, two were 5-star and other two reviews were 4-star ratings
* Profile views 
  * Oct - 22,484
  * Sep - 24,465
  * Aug - 16,846
  * Jul - 11,633
  * Jun - 15,007
  * May - 16,669
  * Apr - 22,180
  * Mar - 25,049 
  * Feb - 24,093
  * Jan - 17,910
* Over 70% of the Google searches were preformed on desktop; while the rest were on mobile. The percentage of searches using desktop computers have slightly decreased since last fall.   

